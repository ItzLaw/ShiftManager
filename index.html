<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Shift Manager Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login System Styles */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }

        .login-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 1rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #fcc;
            font-size: 0.9rem;
            display: none;
        }

        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .user-info .user-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .user-info .user-role {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .access-denied {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            text-align: center;
            color: #856404;
        }

        .access-denied h3 {
            margin-bottom: 10px;
            color: #f39c12;
        }

        .admin-only {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }

        .admin-only h4 {
            color: #2e7d32;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-only .admin-icon {
            color: #27ae60;
            font-size: 1.2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: #3498db;
            color: white;
        }

        .nav-tab:hover {
            background: #2980b9;
            color: white;
        }

        .live-indicator {
            font-size: 0.7rem;
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .calendar-container {
            padding: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .calendar-filter-indicator {
            display: flex;
            align-items: center;
        }

        .filter-indicator {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .month-navigator {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .day-header {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
        }

        .day-cell {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            min-height: 140px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .day-cell:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .day-cell.selected {
            border-color: #3498db;
            background: #ebf3fd;
        }

        .day-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .shift-indicators {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .shift-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-green { background: #27ae60; }
        .status-orange { background: #e67e22; }
        .status-purple { background: #9b59b6; }
        .status-red { background: #e74c3c; }
        .status-gray { background: #95a5a6; }

        .stars-display {
            font-size: 0.7rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .star-count {
            color: #f39c12;
            font-weight: bold;
        }

        .daily-earnings {
            font-size: 0.7rem;
            color: #27ae60;
            font-weight: bold;
            margin-top: 3px;
        }

        .shift-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            z-index: 1000;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .modal-header {
            background: #007bff;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .shifts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .shift-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 100%;
            overflow: hidden;
        }

        .shift-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #007bff;
        }

        .shift-title {
            font-size: 1rem;
            font-weight: bold;
            color: #007bff;
        }

        .shift-time {
            font-size: 0.8rem;
            color: #666;
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 3px;
        }

        .employee-slots-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .employee-slot {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            position: relative;
        }

        .employee-slot-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .employee-select {
            flex: 1;
            min-width: 100px;
            padding: 4px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .late-select {
            min-width: 120px;
            padding: 4px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 0.8rem;
            background: #fff;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .stars-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 3px;
            padding: 6px;
            margin-top: 6px;
        }

        .stars-input-group {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            width: 100%;
        }

        .stars-input {
            width: 60px;
            padding: 3px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
            font-size: 0.85rem;
        }



        .replacement-container {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 3px;
            padding: 6px;
            margin-top: 6px;
        }

        .replacement-row {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .replacement-select {
            min-width: 100px;
            padding: 3px 4px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .replacement-stars {
            width: 50px;
            padding: 3px 4px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
            font-size: 0.8rem;
        }

        .full-cover-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: #2e7d32;
        }

        .full-cover-checkbox {
            width: 14px;
            height: 14px;
        }

        .management-issue-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 3px;
            padding: 8px;
            margin-top: 8px;
        }

        .management-issue-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            color: #856404;
            margin-bottom: 3px;
            font-size: 0.85rem;
        }

        .management-issue-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #f39c12;
        }

        .management-issue-help {
            font-size: 0.75rem;
            color: #856404;
            margin-top: 3px;
        }

        .reason-section {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 3px;
            padding: 8px;
            margin-top: 8px;
        }

        .reason-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #bbdefb;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .replacement-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #8e44ad;
            color: #fff;
            font-size: 0.65rem;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 8px;
            cursor: default;
        }

        /* Modal Footer */
        .modal-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            border-top: 1px solid #dee2e6;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .save-btn:hover {
            background: #218838;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        /* Performance Section Styles */
        .performance-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .performance-section h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.4rem;
        }

        .performance-controls {
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .performance-controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .performance-controls button:hover {
            background: #0056b3;
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
        }

        .performance-table th {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .performance-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .performance-table tbody tr:hover {
            background: #f8f9fa;
        }

        .performance-table tbody tr:last-child td {
            border-bottom: none;
        }

        .performance-table .rank-1 { 
            background: #fff3cd; 
            border-left: 3px solid #f39c12;
        }
        
        .performance-table .rank-2 { 
            background: #f8f9fa; 
            border-left: 3px solid #6c757d;
        }
        
        .performance-table .rank-3 { 
            background: #fff5f5; 
            border-left: 3px solid #e74c3c;
        }

        .no-data-message {
            text-align: center;
            padding: 32px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
        }

        .no-data-message h4 {
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .filter-summary {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .filter-summary h4 {
            margin: 0 0 8px 0;
            color: #1976d2;
            font-size: 1rem;
        }

        .daily-earnings-summary {
            font-size: 0.9rem;
            color: #424242;
            line-height: 1.4;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 90vw;
                width: 90vw;
                max-height: 90vh;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
            }

            .modal-header {
                padding: 10px 12px;
            }

            .modal-header h2 {
                font-size: 1rem;
            }

            .modal-body {
                padding: 12px;
            }

            .shift-card {
                padding: 8px;
            }
            
            .employee-slot {
                padding: 6px;
            }
            
            .employee-slot-header {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            
            .employee-select,
            .late-select {
                min-width: 100%;
            }
            
            .stars-input-group {
                justify-content: center;
            }
            
            .replacement-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .replacement-select,
            .replacement-stars {
                min-width: 100%;
            }

            .performance-controls {
                flex-direction: column;
            }

            .performance-controls button {
                margin-right: 0;
                margin-bottom: 8px;
            }

            .performance-table {
                font-size: 0.8rem;
            }

            .performance-table th,
            .performance-table td {
                padding: 8px 6px;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                max-width: 95vw;
                width: 95vw;
                max-height: 95vh;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
            }

            .modal-header {
                padding: 8px 10px;
            }

            .modal-header h2 {
                font-size: 0.9rem;
            }

            .modal-body {
                padding: 8px;
            }

            .shift-card {
                padding: 6px;
            }

            .employee-slot {
                padding: 4px;
            }

            .employee-select,
            .late-select {
                font-size: 0.8rem;
                padding: 3px 4px;
            }

            .stars-input {
                width: 50px;
                font-size: 0.8rem;
            }

            .add-stars-btn {
                font-size: 0.7rem;
                padding: 3px 6px;
            }
        }

        /* Weekend Priority Section Styles */
        .weekend-priority-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .weekend-priority-section h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.4rem;
        }

        .weekend-priority-controls {
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .weekend-priority-controls button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .weekend-priority-controls button:hover {
            background: #138496;
        }

        .weekend-priority-rules {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .weekend-priority-rules h4 {
            color: #1976d2;
            margin: 0 0 12px 0;
            font-size: 1.1rem;
        }

        .weekend-priority-rules ul {
            margin: 0;
            padding-left: 20px;
        }

        .weekend-priority-rules li {
            margin-bottom: 8px;
            color: #424242;
            line-height: 1.5;
        }

        .weekend-priority-rules strong {
            color: #1976d2;
        }

        .weekend-priority-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
        }

        .weekend-priority-table th {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .weekend-priority-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .weekend-priority-table tbody tr:hover {
            background: #f8f9fa;
        }

        .weekend-priority-table tbody tr:last-child td {
            border-bottom: none;
        }

        .priority-1 {
            background: #fff3cd;
            border-left: 3px solid #f39c12;
        }

        .priority-2 {
            background: #f8f9fa;
            border-left: 3px solid #6c757d;
        }

        .priority-3 {
            background: #fff5f5;
            border-left: 3px solid #e74c3c;
        }

        .missed-shift-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .no-pass-badge {
            background: #e67e22;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .absent-badge {
            background: #9b59b6;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .partner-no-show-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .high-performer-badge {
            background: #27ae60;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .standard-priority-badge {
            background: #27ae60;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .no-work-badge {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .no-weekend-data {
            text-align: center;
            padding: 32px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
        }

        .no-weekend-data h4 {
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .leaderboard-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .leaderboard-controls {
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .leaderboard-controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .leaderboard-controls button:hover {
            background: #0056b3;
        }

        .leaderboard-rules {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .leaderboard-rules h4 {
            color: #1976d2;
            margin: 0 0 12px 0;
            font-size: 1.1rem;
        }

        .leaderboard-rules ul {
            margin: 0;
            padding-left: 20px;
        }

        .leaderboard-rules li {
            margin-bottom: 8px;
            color: #424242;
            line-height: 1.5;
        }

        .leaderboard-rules strong {
            color: #1976d2;
        }

        .leaderboard-prizes {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .prize-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .prize-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .medal {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .rank {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .amount {
            font-size: 1rem;
            color: #27ae60;
            font-weight: bold;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .leaderboard-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .leaderboard-table tbody tr:hover {
            background: #f8f9fa;
        }

        .leaderboard-table tbody tr:last-child td {
            border-bottom: none;
        }

        .leaderboard-table .rank-1 { 
            background: #fff3cd; 
            border-left: 3px solid #f39c12;
        }
        
        .leaderboard-table .rank-2 { 
            background: #f8f9fa; 
            border-left: 3px solid #6c757d;
        }
        
        .leaderboard-table .rank-3 { 
            background: #fff5f5; 
            border-left: 3px solid #e74c3c;
        }

        /* Predefined Lists Management Styles */
        .predefined-lists-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .predefined-lists-section h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.4rem;
        }

        .config-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h4 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .config-section p {
            color: #6c757d;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .shift-assignments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .shift-assignment {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            min-width: 0; /* Prevent grid items from overflowing */
        }

        .shift-assignment label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .employee-inputs {
            display: flex;
            gap: 10px;
            min-width: 0; /* Prevent flex container from overflowing */
        }

        .employee-inputs input {
            flex: 1;
            min-width: 0; /* Prevent input from overflowing */
            max-width: 120px; /* Set maximum width for inputs */
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .employee-inputs input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .star-rates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .star-rate-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .star-rate-row label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 100px;
        }

        .star-rate-row input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
        }

        .star-rate-row span {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .weekend-rate {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .weekend-rate label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 200px;
        }

        .weekend-rate input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
        }

        .weekend-rate span {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .bonus-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .bonus-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .bonus-row label {
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
            font-size: 0.9rem;
        }

        .bonus-row input {
            width: 100px;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
        }

        .bonus-row span {
            color: #6c757d;
            font-size: 0.9rem;
            min-width: 20px;
        }

        .prize-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .prize-config-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .prize-config-row label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 80px;
        }

        .prize-config-row input {
            width: 100px;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
        }

        .prize-config-row span {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .total-prize-pool {
            text-align: center;
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
            padding: 16px;
            color: #2e7d32;
            font-size: 1.1rem;
        }

        .config-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .save-config-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .save-config-btn:hover {
            background: #218838;
        }

        /* Collapsible section styles */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px 6px 0 0;
            transition: background-color 0.3s ease;
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .toggle-icon {
            font-size: 1.2rem;
            color: #6c757d;
            transition: transform 0.3s ease;
        }

        .collapsible-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 20px;
            background: white;
        }

        /* Responsive adjustments for predefined lists */
        @media (max-width: 768px) {
            .shift-assignments-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .star-rates-grid {
                grid-template-columns: 1fr;
            }
            
            .bonus-grid {
                grid-template-columns: 1fr;
            }
            
            .prize-config-grid {
                grid-template-columns: 1fr;
            }
            
            .config-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .employee-inputs {
                flex-direction: column;
                gap: 8px;
            }
            
            .employee-inputs input {
                max-width: none; /* Remove max-width constraint on mobile */
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login System -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <h1>üîê Shift Manager</h1>
                <p>Please login to access the system</p>
            </div>
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <div class="error-message" id="errorMessage"></div>
                <button type="submit" class="login-btn" id="loginBtn">Login</button>
            </form>
        </div>
    </div>

    <!-- User Info Display -->
    <div class="user-info" id="userInfo">
        <div class="user-name" id="userName"></div>
        <div class="user-role" id="userRole"></div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="header">
            <div style="position: relative;">
                <h1>üìÖ Enhanced Shift Manager Calendar</h1>
                <p>Manage daily shifts with star tracking, payment calculations, and comprehensive overview</p>
                <div id="dataStatusIndicator" style="background: #e8f5e8; padding: 8px 12px; border-radius: 4px; margin-top: 8px; border: 1px solid #c3e6c3; display: none;">
                    <span id="lastSavedText" style="color: #2e7d32; font-size: 0.9rem;"></span>
                    <button onclick="saveDataToStorage()" style="margin-left: 12px; background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">üíæ Save Now</button>
                </div>
                <div style="background: #e3f2fd; padding: 8px 12px; border-radius: 4px; margin-top: 8px; border: 1px solid #bbdefb; text-align: center;">
                    <span style="color: #1976d2; font-size: 0.9rem;">
                        <strong>üí° Default Assignments:</strong> <span id="defaultAssignmentsDisplay">Loading...</span>
                    </span>
                </div>
                
                <!-- Admin Login Button -->
                <button id="adminLoginBtn" onclick="showLoginScreen()" style="position: absolute; top: 10px; right: 10px; background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: none;">
                    üîê Admin Login
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('calendar')">üìÖ Calendar</button>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar-tab" class="tab-content active">
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="month-navigator">
                        <button class="nav-btn" onclick="previousMonth()">‚Üê Previous</button>
                        <div class="current-month" id="currentMonth">January 2024</div>
                        <button class="nav-btn" onclick="nextMonth()">Next ‚Üí</button>
                    </div>
            <div id="calendarFilterIndicator"></div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be generated here -->
                </div>

                <div class="legend">
                    <h3>üìä Status Indicators</h3>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-dot status-green"></div>
                            <span>üü¢ Green: Work completed (stars > 0)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot status-orange"></div>
                            <span>üü† Orange: No Show</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot status-purple"></div>
                            <span>üü£ Purple: Absent</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot status-red"></div>
                            <span>üî¥ Red: Management issues (no pass, etc.)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot status-gray"></div>
                            <span>‚ö´ Gray: No assignment</span>
                        </div>
                    </div>
                </div>

                <!-- Individual Performance Table -->
                <div class="performance-section" id="performanceTableContainer">
                    <h3 style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <span>üìä Individual Performance</span>
                        <button onclick="refreshPerformanceData()" title="Refresh" style="background: #28a745; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üîÑ Refresh</button>
                    </h3>
                    <div class="admin-only" id="adminOnlyPerformance">
                        <h4><span class="admin-icon">üîí</span> Manager & Admin Only - Data Management</h4>
                        <p>Only managers and administrators can modify shift data, add sample data, or clear records.</p>
                    </div>
                    <div class="performance-controls" id="performanceControls">
                        <button onclick="calculatePerformance()" class="admin-only-btn">üìà Calculate Performance</button>
                        <button onclick="showMonthClearSelector()" class="admin-only-btn" style="background: #e67e22;">üóëÔ∏è Clear Month Data</button>
                        <button onclick="exportData()" class="admin-only-btn" style="background: #17a2b8;">üíæ Export Data</button>
                        <button onclick="importData()" class="admin-only-btn" style="background: #6f42c1;">üì• Import Data</button>
                        <button onclick="refreshPerformanceData()" style="background: #28a745;">üîÑ Refresh Data</button>
                    </div>
                    <div id="performanceTable"></div>
                </div>

                <div class="weekend-priority-section" id="weekendPriorityContainer">
                    <h3 style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <span>üèñÔ∏è Weekend Shift Priority</span>
                        <button onclick="refreshWeekendPriorityData()" title="Refresh" style="background: #28a745; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üîÑ Refresh</button>
                    </h3>
                    <div class="admin-only" id="adminOnlyWeekend">
                        <h4><span class="admin-icon">üîí</span> Manager & Admin Only - Priority Management</h4>
                        <p>Only managers and administrators can calculate and modify weekend shift priorities.</p>
                    </div>
                    <div id="viewerNote" style="display: none; background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 8px; padding: 15px; margin: 15px 0; border-left: 4px solid #27ae60;">
                        <h4 style="color: #2e7d32; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span style="color: #27ae60; font-size: 1.2rem;">üëÅÔ∏è</span> Viewer Mode - Read Only Access
                        </h4>
                        <p style="color: #2e7d32; margin: 0;">You can view weekend shift priority data that has been calculated by managers. The data will automatically update when available.</p>
                    </div>
                    <div class="weekend-priority-controls" id="weekendPriorityControls">
                        <button onclick="calculateWeekendPriority()" class="admin-only-btn">üîÑ Calculate Priority</button>
                        <button onclick="showWeekendRules()">üìã View Rules</button>
                        <button onclick="refreshWeekendPriorityData()" style="background: #28a745;">üîÑ Refresh Data</button>
                    </div>
                    <div class="weekend-priority-rules" style="display: none;">
                        <h4>Weekend Shift Assignment Rules:</h4>
                        <ul>
                            <li><strong>First Preference:</strong> Team members who missed shifts due to reasons beyond their control (partner absence, management issues)</li>
                            <li><strong>Second Preference:</strong> Remaining slots based on star performance (highest performers first)</li>
                            <li><strong>Note:</strong> If top performers decline, slots pass to next eligible team member</li>
                        </ul>
                    </div>
                    <div id="weekendPriorityTable"></div>
                </div>

                <div class="leaderboard-section" id="leaderboardContainer">
                    <h3 style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <span>üèÜ Weekly Leaderboard Incentives (Experimental)</span>
                        <button onclick="refreshLeaderboardData()" title="Refresh" style="background: #28a745; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üîÑ Refresh</button>
                    </h3>
                    <div class="admin-only" id="adminOnlyLeaderboard">
                        <h4><span class="admin-icon">üîí</span> Manager & Admin Only - Leaderboard Management</h4>
                        <p>Only managers and administrators can calculate leaderboards and manage weekly data.</p>
                    </div>
                    <div class="leaderboard-controls" id="leaderboardControls">
                        <button onclick="calculateWeeklyLeaderboard()" class="admin-only-btn">üìä Calculate Weekly Leaderboard</button>
                        <button onclick="goToCurrentWeek()" style="background: #28a745;">üìÖ Current Week</button>
                        <button onclick="selectWeek()">üìÖ Select Week</button>
                        <button onclick="showLeaderboardRules()">üìã View Rules</button>
                        <button onclick="showLeaderboardPrizes()">üí∞ View Prizes</button>
                        <button onclick="refreshLeaderboardData()" style="background: #28a745;">üîÑ Refresh Data</button>
                    </div>
                    <div id="currentWeekIndicator" style="background: #e3f2fd; padding: 8px 12px; border-radius: 4px; margin-bottom: 16px; border: 1px solid #bbdefb; text-align: center; display: none;">
                        <strong>üìÖ Currently Viewing:</strong> <span id="weekDisplayText"></span>
                    </div>
                    <div class="week-selector" style="display: none; background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #dee2e6;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <label for="weekInput" style="font-weight: bold;">Select Week (Monday to Sunday):</label>
                            <input type="week" id="weekInput" style="padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button onclick="calculateSelectedWeek()" style="background: #007bff; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Go</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                            <button onclick="goToPreviousWeek()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">‚Üê Previous Week</button>
                            <button onclick="goToCurrentWeek()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Current Week</button>
                            <button onclick="goToNextWeek()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Next Week ‚Üí</button>
                        </div>
                        <div style="margin-top: 8px; text-align: center;">
                            <label for="quickWeekSelect" style="font-size: 0.9rem; color: #666;">Quick Select:</label>
                            <select id="quickWeekSelect" onchange="goToQuickWeek()" style="margin-left: 8px; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;">
                                <option value="">-- Select Week --</option>
                                <option value="current">Current Week</option>
                                <option value="last1">Last Week</option>
                                <option value="last2">2 Weeks Ago</option>
                                <option value="last3">3 Weeks Ago</option>
                                <option value="last4">4 Weeks Ago</option>
                                <option value="last8">8 Weeks Ago</option>
                                <option value="last12">12 Weeks Ago</option>
                            </select>
                        </div>
                    </div>
                    <div class="leaderboard-rules" style="display: none;">
                        <h4>Weekly Leaderboard Rules:</h4>
                        <ul>
                            <li><strong>Eligibility:</strong> Must complete >150 stars during regular weekday shifts (Mon-Fri)</li>
                            <li><strong>Week Period:</strong> Monday to Sunday (7-day cycle)</li>
                            <li><strong>Weekend Compensation:</strong> Missed weekday shifts due to partner absence or management issues can be compensated by weekend shifts</li>
                            <li><strong>Multiple Shifts:</strong> Only max 10 stars from second shift count towards leaderboard (full earnings still apply)</li>
                            <li><strong>Tie-Break:</strong> Higher attendance wins, then equal prize split if still tied</li>
                        </ul>
                    </div>
                    <div class="leaderboard-prizes" style="display: none;">
                        <h4>üèÜ Weekly Prize Distribution:</h4>
                        <div class="prize-grid">
                            <div class="prize-item gold">
                                <span class="medal">ü•á</span>
                                <span class="rank">1st Place</span>
                                <span class="amount">‚Çπ1,250</span>
                            </div>
                            <div class="prize-item silver">
                                <span class="medal">ü•à</span>
                                <span class="rank">2nd Place</span>
                                <span class="amount">‚Çπ750</span>
                            </div>
                            <div class="prize-item bronze">
                                <span class="medal">ü•â</span>
                                <span class="rank">3rd Place</span>
                                <span class="amount">‚Çπ500</span>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 12px; color: #666; font-size: 0.9rem;">
                            <strong>Total Weekly Prize Pool: ‚Çπ2,500</strong><br>
                            <em>Monthly total: ‚Çπ10,000 (4 weeks √ó ‚Çπ2,500)</em>
                        </div>
                    </div>
                    <div id="leaderboardTable"></div>
                </div>

                <!-- Predefined Lists Management Section (Admin Only) -->
                <div class="predefined-lists-section admin-only" id="predefinedListsContainer" style="display: none;">
                    <div class="collapsible-header" onclick="togglePredefinedLists()">
                        <h3>‚öôÔ∏è Predefined Lists Management (Raghu Only)</h3>
                        <span class="toggle-icon" id="predefinedListsToggle">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="predefinedListsContent" style="display: none;">
                        <div class="admin-only" id="adminOnlyPredefined">
                            <h4><span class="admin-icon">üîí</span> Admin Only - System Configuration</h4>
                            <p>Manage default employee assignments, star rates, and other system configurations.</p>
                        </div>
                    
                    <!-- Default Employee Assignments -->
                    <div class="config-section">
                        <h4>üë• Default Employee Assignments</h4>
                        <p>Set default employees for each shift type when no specific assignment is made.</p>
                        <div class="shift-assignments-grid">
                            <div class="shift-assignment">
                                <label>üåÖ Morning Shift (6AM-12PM)</label>
                                <div class="employee-inputs">
                                    <input type="text" id="default-morning-1" placeholder="Employee 1" value="Bhargav">
                                    <input type="text" id="default-morning-2" placeholder="Employee 2" value="Pranav">
                                </div>
                            </div>
                            <div class="shift-assignment">
                                <label>‚òÄÔ∏è Afternoon Shift (12PM-6PM)</label>
                                <div class="employee-inputs">
                                    <input type="text" id="default-afternoon-1" placeholder="Employee 1" value="Guru">
                                    <input type="text" id="default-afternoon-2" placeholder="Employee 2" value="Kalyan">
                                </div>
                            </div>
                            <div class="shift-assignment">
                                <label>üåÜ Evening Shift (6PM-12AM)</label>
                                <div class="employee-inputs">
                                    <input type="text" id="default-evening-1" placeholder="Employee 1" value="Nawaz">
                                    <input type="text" id="default-evening-2" placeholder="Employee 2" value="Nithin">
                                </div>
                            </div>
                            <div class="shift-assignment">
                                <label>üåô Night Shift (12AM-6AM)</label>
                                <div class="employee-inputs">
                                    <input type="text" id="default-night-1" placeholder="Employee 1" value="Vishrut">
                                    <input type="text" id="default-night-2" placeholder="Employee 2" value="Vishnu">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Star Rate Configuration -->
                    <div class="config-section">
                        <h4>‚≠ê Star Rate Configuration</h4>
                        <p>Configure payment rates based on star performance (weekdays only).</p>
                        <div class="star-rates-grid">
                            <div class="star-rate-row">
                                <label>0-20 stars:</label>
                                <input type="number" id="star-rate-0-20" value="9" min="0" step="0.01">
                                <span>‚Çπ per star</span>
                            </div>
                            <div class="star-rate-row">
                                <label>22-30 stars:</label>
                                <input type="number" id="star-rate-22-30" value="11" min="0" step="0.01">
                                <span>‚Çπ per star</span>
                            </div>
                            <div class="star-rate-row">
                                <label>32-40 stars:</label>
                                <input type="number" id="star-rate-32-40" value="13.60" min="0" step="0.01">
                                <span>‚Çπ per star</span>
                            </div>
                            <div class="star-rate-row">
                                <label>42+ stars:</label>
                                <input type="number" id="star-rate-42-plus" value="14.60" min="0" step="0.01">
                                <span>‚Çπ per star</span>
                            </div>
                        </div>
                        <div class="weekend-rate">
                            <label>üåÖ Weekend Rate (Saturday/Sunday):</label>
                            <input type="number" id="weekend-rate" value="14.60" min="0" step="0.01">
                            <span>‚Çπ per star (flat rate)</span>
                        </div>
                    </div>

                    <!-- Bonus Configuration -->
                    <div class="config-section">
                        <h4>üéÅ Bonus Configuration</h4>
                        <p>Set bonus amounts for various achievements.</p>
                        <div class="bonus-grid">
                            <div class="bonus-row">
                                <label>üéØ Target Achievement Bonus (800+ stars):</label>
                                <input type="number" id="bonus-800-stars" value="1000" min="0" step="100">
                                <span>‚Çπ</span>
                            </div>
                            <div class="bonus-row">
                                <label>üìÖ Attendance Bonus (20+ working days):</label>
                                <input type="number" id="bonus-20-days" value="1000" min="0" step="100">
                                <span>‚Çπ</span>
                            </div>
                            <div class="bonus-row">
                                <label>‚õΩ Fuel Bonus (20+ working days):</label>
                                <input type="number" id="bonus-fuel" value="1000" min="0" step="100">
                                <span>‚Çπ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Leaderboard Prize Configuration -->
                    <div class="config-section">
                        <h4>üèÜ Leaderboard Prize Configuration</h4>
                        <p>Configure weekly leaderboard prize amounts.</p>
                        <div class="prize-config-grid">
                            <div class="prize-config-row">
                                <label>ü•á 1st Place:</label>
                                <input type="number" id="prize-1st" value="1250" min="0" step="100">
                                <span>‚Çπ</span>
                            </div>
                            <div class="prize-config-row">
                                <label>ü•à 2nd Place:</label>
                                <input type="number" id="prize-2nd" value="750" min="0" step="100">
                                <span>‚Çπ</span>
                            </div>
                            <div class="prize-config-row">
                                <label>ü•â 3rd Place:</label>
                                <input type="number" id="prize-3rd" value="500" min="0" step="100">
                                <span>‚Çπ</span>
                            </div>
                        </div>
                        <div class="total-prize-pool">
                            <strong>Total Weekly Prize Pool: <span id="total-prize-pool">‚Çπ2,500</span></strong>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="config-actions">
                        <button onclick="savePredefinedLists()" class="save-config-btn">üíæ Save Configuration</button>
                    </div>
                        </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Shift Assignment Modal -->
    <div class="shift-modal" id="shiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDate">Assign Shifts & Track Stars</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shifts-container" id="shiftsContainer">
                    <!-- Shifts will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button class="save-btn" onclick="saveShifts()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Authentication System
        let currentUser = null;
        let isAdmin = false;
        
        // Pre-defined users (in production, these would be stored securely on a server)
        const users = {
            'Raghu': {
                username: 'Raghu',
                password: '@tmTPbhb123 shit', // In production, use hashed passwords
                role: 'manager',
                displayName: 'Raghu',
                canEditPredefinedLists: true // Only Raghu can edit predefined lists
            },
            'Bhargav': {
                username: 'Bhargav',
                password: 'Ind@0509',
                role: 'manager',
                displayName: 'Bhargav',
                canEditPredefinedLists: false // Bhargav cannot edit predefined lists
            }
        };

        // Global variables
        let currentDate = new Date();
        let selectedDate = null;
        let shiftData = {};
        let currentTab = 'calendar';
        let filteredEmployee = null; // Track which employee is being filtered
        let originalShiftData = {}; // Store original data when filtering
        
        // Pre-defined employees for each shift (will be updated from saved config)
        let defaultEmployees = {
            morning: ['Bhargav', 'Pranav'],
            afternoon: ['Guru', 'Kalyan'],
            evening: ['Nawaz', 'Nithin'],
            night: ['Vishrut', 'Vishnu']
        };

        // All available employees (will be updated dynamically from defaultEmployees)
        let allEmployees = [
            'Bhargav', 'Pranav', 'Guru', 'Kalyan', 'Nawaz', 'Nithin', 'Vishrut', 'Vishnu'
        ];

        // Shift configurations
        const shifts = [
            { id: 'morning', name: 'Morning', time: '6AM-12PM' },
            { id: 'afternoon', name: 'Afternoon', time: '12PM-6PM' },
            { id: 'evening', name: 'Evening', time: '6PM-12AM' },
            { id: 'night', name: 'Night', time: '12AM-6AM' }
        ];

        // Payment rules
        let starRates = [
            { min: 0, max: 20, rate: 9 },
            { min: 22, max: 30, rate: 11 },
            { min: 32, max: 40, rate: 13.60 },
            { min: 42, max: Infinity, rate: 14.60 }
        ];

        // Global variables for configuration
        let weekendRate = 1.5;
        let bonuses = {
            target800: 1000,
            attendance20: 1000,
            fuel: 1000
        };
        let prizes = {
            first: 1250,
            second: 750,
            third: 500
        };



        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in as admin
            checkAuthStatus();
        });

        // Authentication Functions
        function checkAuthStatus() {
            const savedUser = localStorage.getItem('shiftManagerUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (user.username && users[user.username]) {
                        loginUser(user.username);
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                }
            }
            // Load directly into viewer mode if no admin user
            loadViewerMode();
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');

            // Clear previous error
            errorMessage.style.display = 'none';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            // Simple authentication (in production, use proper server-side validation)
            if (users[username] && users[username].password === password) {
                loginUser(username);
            } else {
                errorMessage.textContent = 'Invalid username or password';
                errorMessage.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        function loginUser(username) {
            const user = users[username];
            currentUser = user;
            isAdmin = user.role === 'manager' || user.role === 'admin'; // Managers have admin-like access
            
            // Save user session
            localStorage.setItem('shiftManagerUser', JSON.stringify(user));
            
            // Hide login screen
            document.getElementById('loginContainer').classList.add('hidden');
            
            // Show user info
            document.getElementById('userName').textContent = user.displayName;
            document.getElementById('userRole').textContent = user.role === 'manager' ? 'Manager' : (user.role === 'admin' ? 'Administrator' : 'Viewer');
            document.getElementById('userInfo').style.display = 'block';
            
            // Initialize app based on user role
            initializeApp();
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            
            // Clear session
            localStorage.removeItem('shiftManagerUser');
            
            // Hide user info
            document.getElementById('userInfo').style.display = 'none';
            
            // Return to viewer mode
            loadViewerMode();
        }

        function showLoginScreen() {
            document.getElementById('loginContainer').classList.remove('hidden');
            // Don't hide the main container - keep it visible for viewer mode
        }

        function loadViewerMode() {
            // Set up viewer mode (non-admin)
            currentUser = null;
            isAdmin = false;
            
            // Hide login screen
            document.getElementById('loginContainer').classList.add('hidden');
            
            // Show main app in viewer mode
            document.querySelector('.container').style.display = 'block';
            
            // Set up role-based access control for viewer
            setupRoleBasedAccess();
            
            // Load saved data from localStorage
            if (loadDataFromStorage()) {
                console.log('Data loaded from storage successfully');
            } else {
                console.log('No saved data found, starting fresh');
            }
            
            // Start auto-save functionality
            autoSaveData();
            
            // Generate calendar with loaded data
            generateCalendar();
            
            // Clear outdated weekend priority data first
            clearOutdatedWeekendPriorityData();
            
            // Display weekend priority data if available for viewers
            setTimeout(() => {
                if (document.getElementById('weekendPriorityTable')) {
                    displayExistingWeekendPriorityData();
                }
            }, 500);
        }

        function initializeApp() {
            // Show main app
            document.querySelector('.container').style.display = 'block';
            
            // Set up role-based access control
            setupRoleBasedAccess();
            
            // Load saved configuration (including default employees)
            loadSavedConfiguration();
            
            // Load saved data from localStorage
            if (loadDataFromStorage()) {
                console.log('Data loaded from storage successfully');
            } else {
                console.log('No saved data found, starting fresh');
            }
            
            // Start auto-save functionality
            autoSaveData();
            
            // Generate calendar with loaded data
            generateCalendar();
            
            // Clear outdated weekend priority data first
            clearOutdatedWeekendPriorityData();
            
            // Display weekend priority data if available
            setTimeout(() => {
                if (document.getElementById('weekendPriorityTable')) {
                    // For admins, try to display existing data first, then calculate if needed
                    const storedData = localStorage.getItem('weekendPriorityData');
                    if (storedData) {
                        try {
                            const parsedData = JSON.parse(storedData);
                            const currentMonth = currentDate.getMonth();
                            const currentYear = currentDate.getFullYear();
                            
                            if (parsedData.month === currentMonth && parsedData.year === currentYear) {
                                displayWeekendPriorityTable(parsedData.data);
                            } else {
                                // Data is outdated, calculate new data
                                calculateWeekendPriority();
                            }
                        } catch (error) {
                            // If there's an error parsing stored data, calculate new data
                            calculateWeekendPriority();
                        }
                    } else {
                        // No stored data, calculate new data
                        calculateWeekendPriority();
                    }
                }
            }, 500);
        }

        function setupRoleBasedAccess() {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            const adminOnlyButtons = document.querySelectorAll('.admin-only-btn');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const viewerNote = document.getElementById('viewerNote');
            
            if (isAdmin) {
                // Show admin-capable elements
                adminOnlyElements.forEach(el => el.style.display = 'block');
                
                // Hide viewer note for admins
                if (viewerNote) viewerNote.style.display = 'none';
                
                // Show admin-only buttons for all managers/admins
                adminOnlyButtons.forEach(btn => btn.style.display = 'inline-block');
                
                // Hide admin login button when logged in as admin/manager
                if (adminLoginBtn) adminLoginBtn.style.display = 'none';
                
                // Special handling for predefined lists entire container (Raghu only)
                const predefinedListsContainer = document.getElementById('predefinedListsContainer');
                if (predefinedListsContainer) {
                    if (currentUser && currentUser.canEditPredefinedLists) {
                        predefinedListsContainer.style.display = 'block';
                    } else {
                        predefinedListsContainer.style.display = 'none';
                    }
                }
            } else {
                // Hide admin elements
                adminOnlyElements.forEach(el => el.style.display = 'none');
                adminOnlyButtons.forEach(btn => btn.style.display = 'none');
                
                // Show viewer note for non-admin users
                if (viewerNote) viewerNote.style.display = 'block';
                
                // Show admin login button when in viewer mode
                if (adminLoginBtn) adminLoginBtn.style.display = 'block';
            }
            
            // Apply security measures based on role
            sanitizeDataForViewers();
        }

        // Security: Prevent right-click context menu
        document.addEventListener('contextmenu', function(e) {
            if (!isAdmin) {
                e.preventDefault();
                return false;
            }
        });

        // Security: Prevent F12, Ctrl+Shift+I, Ctrl+U
        document.addEventListener('keydown', function(e) {
            if (!isAdmin) {
                // Prevent F12
                if (e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
                // Prevent Ctrl+Shift+I (Developer Tools)
                if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                    e.preventDefault();
                    return false;
                }
                // Prevent Ctrl+U (View Source)
                if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    return false;
                }
            }
        });

        // Security: Hide sensitive data from non-admin users
        function sanitizeDataForViewers() {
            if (!isAdmin) {
                // Remove sensitive information from console logs
                const originalLog = console.log;
                console.log = function(...args) {
                    // Only allow basic logs for viewers
                    if (args.length > 0 && typeof args[0] === 'string' && 
                        (args[0].includes('DEBUG') || args[0].includes('shiftData'))) {
                        return; // Block sensitive logs
                    }
                    originalLog.apply(console, args);
                };
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
        }

        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Update filter indicator
            const filterIndicatorContainer = document.getElementById('calendarFilterIndicator');
            if (filteredEmployee) {
                filterIndicatorContainer.innerHTML = `
                    <div class="calendar-filter-indicator">
                        <span class="filter-indicator">üë§ Viewing: ${filteredEmployee}</span>
                    </div>
                `;
            } else {
                filterIndicatorContainer.innerHTML = '';
            }

            // Generate calendar grid
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Generate calendar cells
            for (let i = 0; i < 42; i++) {
                const currentCellDate = new Date(startDate);
                currentCellDate.setDate(startDate.getDate() + i);

                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = currentCellDate.getDate();
                dayCell.appendChild(dayNumber);

                // Add shift indicators
                const indicators = document.createElement('div');
                indicators.className = 'shift-indicators';
                
                const dateKey = formatDate(currentCellDate);
                const dayData = shiftData[dateKey] || {};
                
                shifts.forEach(shift => {
                    const shiftData = dayData[shift.id] || { employees: [], reason: '', stars: {}, late: {}, replacements: {} };
                    const indicator = createShiftIndicator(shift, shiftData);
                    indicators.appendChild(indicator);
                });
                
                dayCell.appendChild(indicators);

                // Add stars display
                const starsDisplay = document.createElement('div');
                starsDisplay.className = 'stars-display';
                const totalStars = calculateDayTotalStars(dayData);
                if (totalStars > 0) {
                    starsDisplay.innerHTML = `‚≠ê <span class="star-count">${totalStars} stars</span>`;
                }
                dayCell.appendChild(starsDisplay);

                // Add daily earnings display when filtering by employee
                if (filteredEmployee) {
                    const dailyEarnings = calculateDayEarningsForEmployee(dayData, filteredEmployee, currentCellDate);
                    if (dailyEarnings > 0) {
                        const earningsDisplay = document.createElement('div');
                        earningsDisplay.className = 'daily-earnings';
                        const isWeekend = currentCellDate.getDay() === 0 || currentCellDate.getDay() === 6;
                        const weekendIndicator = isWeekend ? ' (Weekend)' : '';
                        earningsDisplay.innerHTML = `üí∞ ‚Çπ${dailyEarnings.toLocaleString()}${weekendIndicator}`;
                        dayCell.appendChild(earningsDisplay);
                    }
                }

                // Replacement badge if any replacement exists for this date
                const hasReplacement = (() => {
                    return Object.values(dayData || {}).some(sh => sh && sh.replacements && Object.keys(sh.replacements).length > 0);
                })();
                if (hasReplacement) {
                    const rBadge = document.createElement('div');
                    rBadge.className = 'replacement-badge';
                    rBadge.textContent = 'R';
                    // Build tooltip text
                    const lines = [];
                    Object.keys(dayData || {}).forEach(shId => {
                        const sh = dayData[shId];
                        if (sh && sh.replacements) {
                            Object.keys(sh.replacements).forEach(noShowEmp => {
                                const rep = sh.replacements[noShowEmp];
                                if (rep && rep.employee) {
                                    lines.push(`${noShowEmp} ‚Üí ${rep.employee} (${rep.stars || 0}‚òÖ)`);
                                }
                            });
                        }
                    });
                    if (lines.length > 0) {
                        rBadge.title = `Replacements:\n${lines.join('\n')}`;
                    }
                    dayCell.appendChild(rBadge);
                }

                // Add click event
                dayCell.addEventListener('click', () => openShiftModal(currentCellDate));
                
                // Style current month days differently
                if (currentCellDate.getMonth() !== month) {
                    dayCell.style.opacity = '0.5';
                }

                calendarGrid.appendChild(dayCell);
            }
        }

        function createShiftIndicator(shift, data) {
            const indicator = document.createElement('div');
            indicator.className = 'shift-indicator';
            
            const dot = document.createElement('div');
            dot.className = 'status-dot';
            
            const employeeCount = data.employees ? data.employees.length : 0;
            const hasReason = data.reason && data.reason.trim() !== '';
            
            // Check if work was actually done (stars > 0)
            const hasWorkDone = data.stars && Object.values(data.stars).some(stars => stars > 0);
            
            // Check if any employees are marked as No Show
            const hasNoShow = data.employees && data.employees.some(emp => 
                data.late && data.late[emp] === '1.5hour'
            );
            
            if (employeeCount > 0) {
                if (hasNoShow) {
                    // Employees assigned but marked as No Show
                    dot.classList.add('status-orange');
                } else if (hasWorkDone) {
                    // Employees assigned AND work was done
                    dot.classList.add('status-green');
                } else {
                    // Employees assigned but NO work done (absent)
                    dot.classList.add('status-purple');
                }
            } else if (hasReason) {
                // No employees but there's a reason (management issue, no pass, etc.)
                dot.classList.add('status-red');
            } else {
                // No assignment, no reason
                dot.classList.add('status-gray');
            }
            
            indicator.appendChild(dot);
            
            const label = document.createElement('span');
            label.textContent = shift.name;
            indicator.appendChild(label);
            
            return indicator;
        }

        function calculateDayTotalStars(dayData) {
            let total = 0;
            Object.values(dayData).forEach(shift => {
                if (shift.stars) {
                    Object.values(shift.stars).forEach(starCount => {
                        total += starCount;
                    });
                }
                // Add replacement stars as well
                if (shift.replacements) {
                    Object.values(shift.replacements).forEach(rep => {
                        if (rep && typeof rep.stars === 'number') total += rep.stars;
                    });
                }
            });
            return total;
        }

        function calculateDayEarningsForEmployee(dayData, employeeName, date = null) {
            let totalEarnings = 0;
            
            Object.values(dayData).forEach(shift => {
                if (shift.stars && shift.stars[employeeName]) {
                    const stars = shift.stars[employeeName];
                    const dailyPay = calculateBasicPay(stars, date);
                    totalEarnings += dailyPay;
                }
            });
            
            return totalEarnings;
        }

        function getDailyEarningsSummary(employeeName) {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            let summary = [];
            let totalEarnings = 0;
            
            Object.keys(shiftData).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    const dayData = shiftData[dateKey];
                    const dailyEarnings = calculateDayEarningsForEmployee(dayData, employeeName, date);
                    
                    if (dailyEarnings > 0) {
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                        const dayNumber = date.getDate();
                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                        const weekendIndicator = isWeekend ? ' (Weekend)' : '';
                        summary.push(`${dayName} ${dayNumber}: ‚Çπ${dailyEarnings.toLocaleString()}${weekendIndicator}`);
                        totalEarnings += dailyEarnings;
                    }
                }
            });
            
            if (summary.length > 0) {
                return summary.join(' | ') + `<br><strong>Total: ‚Çπ${totalEarnings.toLocaleString()}</strong>`;
            } else {
                return 'No earnings data for this month';
            }
        }

        function openShiftModal(date) {
            // Check if user has permission to edit
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can edit shift data. You can view the data but cannot make changes.');
                return;
            }
            
            selectedDate = date;
            const dateKey = formatDate(date);
            const dayData = shiftData[dateKey] || {};
            
            document.getElementById('modalDate').textContent = 
                `Assign Shifts & Track Stars - ${date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}`;
            
            generateShiftCards(dayData);
            document.getElementById('shiftModal').style.display = 'block';
        }

        function generateShiftCards(dayData) {
            const container = document.getElementById('shiftsContainer');
            container.innerHTML = '';
            
            shifts.forEach(shift => {
                const shiftData = dayData[shift.id] || { employees: [], reason: '', stars: {}, late: {}, replacements: {} };
                const card = createShiftCard(shift, shiftData);
                container.appendChild(card);
            });
        }

        function createShiftCard(shift, data) {
            const card = document.createElement('div');
            card.className = 'shift-card';
            
            // Header with title and time
            const header = document.createElement('div');
            header.className = 'shift-header';
            
            const title = document.createElement('div');
            title.className = 'shift-title';
            title.textContent = shift.name;
            
            const time = document.createElement('div');
            time.className = 'shift-time';
            time.textContent = shift.time;
            
            header.appendChild(title);
            header.appendChild(time);
            card.appendChild(header);
            
            // Employee slots container
            const slotsContainer = document.createElement('div');
            slotsContainer.className = 'employee-slots-container';
            slotsContainer.id = `slots-${shift.id}`;
            
            // Create employee slots
            for (let i = 0; i < 2; i++) {
                let employeeName = (data.employees && data.employees[i]) ? data.employees[i] : '';
                
                            // If no employee assigned, use default for this shift
            let isDefaultEmployee = false;
            if (!employeeName) {
                const defaultEmployees = getDefaultEmployeesForShift(shift.id);
                if (defaultEmployees[i]) {
                    employeeName = defaultEmployees[i];
                    isDefaultEmployee = true;
                }
            }
                
                const currentStars = employeeName && data.stars ? (data.stars[employeeName] || 0) : 0;
                const lateValue = (data.late && employeeName) ? (data.late[employeeName] || 'none') : 'none';
                const currentRepl = (data.replacements && employeeName) ? (data.replacements[employeeName] || null) : null;
                const slot = createEmployeeSlot(shift.id, i, employeeName, currentStars, lateValue, currentRepl, isDefaultEmployee);
                slotsContainer.appendChild(slot);
            }
            
            card.appendChild(slotsContainer);
            
            // Reason section
            const reasonSection = document.createElement('div');
            reasonSection.className = 'reason-section';
            reasonSection.id = `reason-${shift.id}`;
            
            const reasonLabel = document.createElement('label');
            reasonLabel.textContent = 'Reason for no assignment:';
            reasonLabel.style.display = 'block';
            reasonLabel.style.marginBottom = '6px';
            reasonLabel.style.fontWeight = 'bold';
            reasonLabel.style.color = '#1976d2';
            
            const reasonInput = document.createElement('input');
            reasonInput.type = 'text';
            reasonInput.className = 'reason-input';
            reasonInput.id = `reason-input-${shift.id}`;
            reasonInput.placeholder = 'Enter reason (e.g., No pass, Holiday, etc.)';
            reasonInput.value = data.reason || '';
            
            reasonSection.appendChild(reasonLabel);
            reasonSection.appendChild(reasonInput);
            card.appendChild(reasonSection);
            
            // Management Issue (NO PASS) switch linked to reason
            const managementIssueSection = document.createElement('div');
            managementIssueSection.className = 'management-issue-section';
            
            const managementIssueLabel = document.createElement('label');
            managementIssueLabel.className = 'management-issue-label';
            
            const managementIssueCheckbox = document.createElement('input');
            managementIssueCheckbox.type = 'checkbox';
            managementIssueCheckbox.className = 'management-issue-checkbox';
            managementIssueCheckbox.id = `management-issue-${shift.id}`;
            managementIssueCheckbox.checked = !!data.managementIssue;
            
            const managementIssueText = document.createElement('span');
            managementIssueText.textContent = 'üö´ Management Issue (NO PASS)';
            
            managementIssueLabel.appendChild(managementIssueCheckbox);
            managementIssueLabel.appendChild(managementIssueText);
            managementIssueSection.appendChild(managementIssueLabel);
            
            const managementIssueHelp = document.createElement('div');
            managementIssueHelp.className = 'management-issue-help';
            managementIssueHelp.textContent = 'Auto-fills "No pass" and adjusts bonus eligibility (+40 stars, +1 attendance day, +1 fuel day).';
            managementIssueSection.appendChild(managementIssueHelp);
            
            // Link checkbox to reason auto-fill
            managementIssueCheckbox.addEventListener('change', () => {
                const reasonEl = document.getElementById(`reason-input-${shift.id}`);
                if (!reasonEl) return;
                if (managementIssueCheckbox.checked) {
                    reasonEl.value = 'No pass';
                } else if (reasonEl.value.trim().toLowerCase() === 'no pass') {
                    reasonEl.value = '';
                }
            });
            
            card.appendChild(managementIssueSection);
            
            // Add event listeners for dynamic behavior
            setTimeout(() => {
                updateReasonVisibility(shift.id);
            }, 100);
            
            return card;
        }

        function createEmployeeSlot(shiftId, slotIndex, currentEmployee, currentStars, currentLate = 'none', currentRepl = null, isDefaultEmployee = false) {
            const slot = document.createElement('div');
            slot.className = 'employee-slot';
            

            
            // Employee slot header with select and late dropdown
            const slotHeader = document.createElement('div');
            slotHeader.className = 'employee-slot-header';
            
            const select = document.createElement('select');
            select.className = 'employee-select';
            select.id = `employee-${shiftId}-${slotIndex}`;
            
            // Add empty option
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '-- Select Employee --';
            select.appendChild(emptyOption);
            
            // Add all employees
            allEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                if (employee === currentEmployee) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Add "Add New" option
            const newOption = document.createElement('option');
            newOption.value = 'new';
            newOption.textContent = '‚ûï Add New Employee';
            select.appendChild(newOption);
            
            // Handle "Add New" selection
            select.addEventListener('change', (e) => {
                if (e.target.value === 'new') {
                    const newName = prompt('Enter new employee name:');
                    if (newName && newName.trim()) {
                        allEmployees.push(newName.trim());
                        const newOpt = document.createElement('option');
                        newOpt.value = newName.trim();
                        newOpt.textContent = newName.trim();
                        newOpt.selected = true;
                        select.replaceChild(newOpt, e.target.selectedOptions[0]);
                    } else {
                        e.target.value = '';
                    }
                }
            });
            
            slotHeader.appendChild(select);
            
            // Late arrival dropdown
            const lateSelect = document.createElement('select');
            lateSelect.id = `late-${shiftId}-${slotIndex}`;
            lateSelect.className = 'late-select';
            
            const lateOptions = [
                { value: 'none', label: 'On time (‚Çπ0)' },
                { value: '30min', label: '30 min late (‚Çπ150)' },
                { value: '1hour', label: '1 hour late (‚Çπ200)' },
                { value: '1.5hour', label: '1.5h / No Show (‚Çπ450, partner +‚Çπ250)' },
                { value: 'leave', label: 'Leave (no attendance, replacement needed)' },
            ];
            lateOptions.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.label;
                if (o.value === currentLate) opt.selected = true;
                lateSelect.appendChild(opt);
            });
            slotHeader.appendChild(lateSelect);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => {
                select.value = '';
                updateReasonVisibility(shiftId);
                replacementContainer.style.display = 'none';
            };
            slotHeader.appendChild(removeBtn);
            
            slot.appendChild(slotHeader);
            
            // Replacement mini-slot (hidden until No Show or Leave)
            const replacementContainer = document.createElement('div');
            replacementContainer.className = 'replacement-container';
            replacementContainer.style.display = (currentLate === '1.5hour' || currentLate === 'leave') ? 'block' : 'none';
            
            const replLabel = document.createElement('div');
            replLabel.textContent = currentLate === 'leave' ? 'Replacement for Leave:' : 'Replacement for No Show:';
            replLabel.style.fontWeight = 'bold';
            replLabel.style.color = '#2e7d32';
            replLabel.style.marginBottom = '5px';
            replacementContainer.appendChild(replLabel);
            
            const replRow = document.createElement('div');
            replRow.className = 'replacement-row';
            
            const replSelect = document.createElement('select');
            replSelect.id = `repl-${shiftId}-${slotIndex}`;
            replSelect.className = 'replacement-select';
            
            const replEmpty = document.createElement('option');
            replEmpty.value = '';
            replEmpty.textContent = '-- Select Replacement --';
            replSelect.appendChild(replEmpty);
            
            allEmployees.forEach(emp => {
                const other0 = document.getElementById(`employee-${shiftId}-0`)?.value;
                const other1 = document.getElementById(`employee-${shiftId}-1`)?.value;
                if (emp && emp !== other0 && emp !== other1) {
                    const opt = document.createElement('option');
                    opt.value = emp;
                    opt.textContent = emp;
                    if (currentRepl && currentRepl.employee === emp) opt.selected = true;
                    replSelect.appendChild(opt);
                }
            });
            
            const replStarsInput = document.createElement('input');
            replStarsInput.type = 'number';
            replStarsInput.className = 'replacement-stars';
            replStarsInput.placeholder = 'Stars';
            replStarsInput.id = `repl-stars-${shiftId}-${slotIndex}`;
            if (currentRepl && typeof currentRepl.stars === 'number') replStarsInput.value = String(currentRepl.stars);
            
            const replFullCoverLabel = document.createElement('label');
            replFullCoverLabel.className = 'full-cover-label';
            
            const replFullCoverChk = document.createElement('input');
            replFullCoverChk.type = 'checkbox';
            replFullCoverChk.className = 'full-cover-checkbox';
            replFullCoverChk.id = `repl-full-${shiftId}-${slotIndex}`;
            if (currentRepl && currentRepl.fullyCovered) replFullCoverChk.checked = true;
            const replFullCoverText = document.createElement('span');
            replFullCoverText.textContent = 'Replacement fully covered shift (no +‚Çπ250 to partner)';
            
            replRow.appendChild(replSelect);
            replRow.appendChild(replStarsInput);
            replacementContainer.appendChild(replRow);
            replFullCoverLabel.appendChild(replFullCoverChk);
            replFullCoverLabel.appendChild(replFullCoverText);
            replacementContainer.appendChild(replFullCoverLabel);
            
            slot.appendChild(replacementContainer);
            
            lateSelect.addEventListener('change', () => {
                replacementContainer.style.display = (lateSelect.value === '1.5hour' || lateSelect.value === 'leave') ? 'block' : 'none';
                // Update the replacement label based on the new selection
                if (replLabel) {
                    replLabel.textContent = lateSelect.value === 'leave' ? 'Replacement for Leave:' : 'Replacement for No Show:';
                }
            });
            
            // Add stars section
            const starsSection = document.createElement('div');
            starsSection.className = 'stars-section';
            
            const starsLabel = document.createElement('div');
            starsLabel.textContent = `Stars:`;
            starsLabel.style.fontWeight = 'bold';
            starsLabel.style.color = '#856404';
            starsLabel.style.marginBottom = '8px';
            starsSection.appendChild(starsLabel);
            
            const starsInput = document.createElement('div');
            starsInput.className = 'stars-input-group';
            
            const starsInputField = document.createElement('input');
            starsInputField.type = 'number';
            starsInputField.className = 'stars-input';
            starsInputField.placeholder = 'Stars';
            starsInputField.value = currentStars;
            starsInputField.id = `stars-input-${shiftId}-${slotIndex}`;
            starsInputField.style.width = '100%';
            starsInput.appendChild(starsInputField);
            
            // Add preset star buttons
            const presetButtons = document.createElement('div');
            presetButtons.style.cssText = 'display: flex; gap: 8px; margin-top: 8px;';
            
            const preset40 = document.createElement('button');
            preset40.type = 'button';
            preset40.textContent = '40 ‚≠ê';
            preset40.style.cssText = 'background: #ffc107; color: #856404; border: 1px solid #ffc107; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;';
            preset40.onclick = () => {
                starsInputField.value = '40';
            };
            
            const preset42 = document.createElement('button');
            preset42.type = 'button';
            preset42.textContent = '42 ‚≠ê';
            preset42.style.cssText = 'background: #17a2b8; color: white; border: 1px solid #17a2b8; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;';
            preset42.onclick = () => {
                starsInputField.value = '42';
            };
            
            const preset50 = document.createElement('button');
            preset50.type = 'button';
            preset50.textContent = '50 ‚≠ê';
            preset50.style.cssText = 'background: #28a745; color: white; border: 1px solid #28a745; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;';
            preset50.onclick = () => {
                starsInputField.value = '50';
            };
            
            presetButtons.appendChild(preset40);
            presetButtons.appendChild(preset42);
            presetButtons.appendChild(preset50);
            starsInput.appendChild(presetButtons);
            
            starsSection.appendChild(starsInput);
            slot.appendChild(starsSection);
            
            return slot;
        }

        function updateReasonVisibility(shiftId) {
            const slotsContainer = document.getElementById(`slots-${shiftId}`);
            const reasonSection = document.getElementById(`reason-${shiftId}`);
            const selects = slotsContainer.querySelectorAll('.employee-select');
            
            let hasEmployees = false;
            selects.forEach(select => {
                if (select.value && select.value !== 'new') {
                    hasEmployees = true;
                }
            });
            
            reasonSection.style.display = hasEmployees ? 'none' : 'block';
        }

        function saveShifts() {
            // Check if user has permission to save
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can save shift data.');
                return false;
            }
            
            const dateKey = formatDate(selectedDate);
            const dayData = {};
            
            shifts.forEach(shift => {
                const employees = [];
                const selects = document.querySelectorAll(`#employee-${shift.id}-0, #employee-${shift.id}-1`);
                const stars = {};
                const late = {};
                const replacements = {};
                
                selects.forEach((select, index) => {
                    if (select.value && select.value !== 'new') {
                        const employeeName = select.value;
                        employees.push(employeeName);
                        const starsInput = document.getElementById(`stars-input-${shift.id}-${index}`);
                        const starCount = parseInt(starsInput?.value || '0') || 0;
                        if (starCount > 0) {
                            stars[employeeName] = starCount;
                        }
                        const lateSelect = document.getElementById(`late-${shift.id}-${index}`);
                        const lateCode = lateSelect ? (lateSelect.value || 'none') : 'none';
                        late[employeeName] = lateCode;
                        
                        if (lateCode === '1.5hour' || lateCode === 'leave') {
                            const replName = (document.getElementById(`repl-${shift.id}-${index}`)?.value) || '';
                            const replStars = parseInt(document.getElementById(`repl-stars-${shift.id}-${index}`)?.value || '0') || 0;
                            const fullCover = !!(document.getElementById(`repl-full-${shift.id}-${index}`)?.checked);
                            replacements[employeeName] = { employee: replName, stars: replStars, fullyCovered: fullCover };
                        }
                    }
                });
                
                const reasonInput = document.getElementById(`reason-input-${shift.id}`);
                const reason = employees.length === 0 ? (reasonInput?.value || '') : '';
                
                const managementIssueCheckbox = document.getElementById(`management-issue-${shift.id}`);
                const managementIssue = !!(managementIssueCheckbox && managementIssueCheckbox.checked);
                
                dayData[shift.id] = {
                    employees,
                    reason,
                    stars,
                    late,
                    replacements,
                    managementIssue
                };
            });
            
            shiftData[dateKey] = dayData;
            
            // Auto-save data to localStorage
            saveDataToStorage();
            
            console.log('Saved shift data:', dateKey, dayData);
            
            closeModal();
            generateCalendar();
            
            // Trigger auto-updates for viewers and Bhargav
            setTimeout(() => {
                triggerAllAutoUpdates();
            }, 100);
            
            return true;
        }

        function closeModal() {
            document.getElementById('shiftModal').style.display = 'none';
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
            
            // Clear outdated weekend priority data when month changes
            clearOutdatedWeekendPriorityData();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
            
            // Clear outdated weekend priority data when month changes
            clearOutdatedWeekendPriorityData();
        }

        function formatDate(date) {
            // Use local date formatting to avoid timezone issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function addSampleDataForCurrentMonth() {
            // Check if user has permission to add sample data
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can add sample data.');
                return false;
            }
            
            // Add sample data for the current month being viewed
            const sampleDate1 = new Date(currentDate.getFullYear(), currentDate.getMonth(), 5);
            const sampleDate2 = new Date(currentDate.getFullYear(), currentDate.getMonth(), 7);
            const sampleDate3 = new Date(currentDate.getFullYear(), currentDate.getMonth(), 10);
            
            console.log('Adding sample data for month:', currentDate.getMonth(), 'year:', currentDate.getFullYear());
            console.log('Sample dates:', formatDate(sampleDate1), formatDate(sampleDate2), formatDate(sampleDate3));
            
            // Sample data for August 5th
            shiftData[formatDate(sampleDate1)] = {
                morning: {
                    employees: ['Bhargav', 'Pranav'],
                    reason: '',
                    stars: { 'Bhargav': 40, 'Pranav': 38 },
                    managementIssue: false
                },
                afternoon: {
                    employees: ['Guru', 'Kalyan'],
                    reason: '',
                    stars: { 'Guru': 42, 'Kalyan': 35 },
                    managementIssue: false
                },
                evening: {
                    employees: ['Nawaz', 'Nithin'],
                    reason: '',
                    stars: { 'Nawaz': 45, 'Nithin': 40 },
                    managementIssue: false
                },
                night: {
                    employees: ['Vishrut', 'Vishnu'],
                    reason: '',
                    stars: { 'Vishrut': 38, 'Vishnu': 36 },
                    managementIssue: false
                }
            };
            
            // Sample data for August 7th
            shiftData[formatDate(sampleDate2)] = {
                morning: {
                    employees: ['Bhargav', 'Pranav'],
                    reason: '',
                    stars: { 'Bhargav': 42, 'Pranav': 40 },
                    managementIssue: false
                },
                afternoon: {
                    employees: ['Guru'],
                    reason: '',
                    stars: { 'Guru': 44 },
                    managementIssue: false
                },
                evening: {
                    employees: [],
                    reason: 'No pass',
                    managementIssue: true
                },
                night: {
                    employees: ['Vishrut', 'Vishnu'],
                    reason: '',
                    stars: { 'Vishrut': 40, 'Vishnu': 38 },
                    managementIssue: false
                }
            };
            
            // Sample data for August 10th
            shiftData[formatDate(sampleDate3)] = {
                morning: {
                    employees: ['Bhargav'],
                    reason: '',
                    stars: { 'Bhargav': 46 },
                    managementIssue: false
                },
                afternoon: {
                    employees: ['Guru', 'Kalyan'],
                    reason: '',
                    stars: { 'Guru': 48, 'Kalyan': 42 },
                    managementIssue: false
                },
                evening: {
                    employees: ['Nawaz', 'Nithin'],
                    reason: '',
                    stars: { 'Nawaz': 50, 'Nithin': 45 },
                    managementIssue: false
                },
                night: {
                    employees: ['Vishrut'],
                    reason: '',
                    stars: { 'Vishrut': 44 },
                    managementIssue: false
                }
            };
            
            console.log('Sample data added. Current shiftData:', shiftData);
            generateCalendar();
            
            // Trigger auto-updates for viewers and Bhargav
            setTimeout(() => {
                triggerAllAutoUpdates();
            }, 100);
            
            return true;
        }

        // Developer-only helper removed as unused in production: addAugust1stData()

        function clearAllData() {
            // Check if user has permission to clear data
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can clear all data.');
                return false;
            }
            
            if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL shift data? This action cannot be undone.')) {
                shiftData = {};
                allEmployees = ['Bhargav', 'Pranav', 'Guru', 'Kalyan', 'Nawaz', 'Nithin', 'Vishrut', 'Vishnu'];
                filteredEmployee = null;
                originalShiftData = {};
                
                // Clear from localStorage
                localStorage.removeItem('shiftManagerData');
                
                // Refresh the calendar and performance tables
                generateCalendar();
                if (document.getElementById('performanceTable')) {
                    document.getElementById('performanceTable').innerHTML = '';
                }
                if (document.getElementById('weekendPriorityTable')) {
                    document.getElementById('weekendPriorityTable').innerHTML = '';
                }
                if (document.getElementById('leaderboardTable')) {
                    document.getElementById('leaderboardTable').innerHTML = '';
                }
                
                // Trigger auto-updates for viewers and Bhargav
                setTimeout(() => {
                    triggerAllAutoUpdates();
                }, 100);
                
                alert('All data has been cleared successfully.');
                return true;
            }
            return false;
        }

        function clearMonthData(targetMonth = null, targetYear = null) {
            // Check if user has permission to clear data
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can clear data.');
                return false;
            }
            
            // If no month/year specified, use current month
            if (targetMonth === null) targetMonth = currentDate.getMonth();
            if (targetYear === null) targetYear = currentDate.getFullYear();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Count how many days will be cleared
            let daysToClear = 0;
            const keysToRemove = [];
            
            console.log('=== CLEAR MONTH DEBUG ===');
            console.log('Target month:', targetMonth, 'Target year:', targetYear);
            console.log('All shiftData keys:', Object.keys(shiftData));
            
            Object.keys(shiftData).forEach(dateKey => {
                const date = new Date(dateKey);
                console.log(`Checking dateKey: ${dateKey}`);
                console.log(`  - Parsed date:`, date);
                console.log(`  - Date month: ${date.getMonth()}, year: ${date.getFullYear()}`);
                console.log(`  - Target month: ${targetMonth}, year: ${targetYear}`);
                console.log(`  - Month match: ${date.getMonth() === targetMonth}`);
                console.log(`  - Year match: ${date.getFullYear() === targetYear}`);
                
                if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                    daysToClear++;
                    keysToRemove.push(dateKey);
                    console.log(`‚úÖ INCLUDING date: ${dateKey}`);
                } else {
                    console.log(`‚ùå EXCLUDING date: ${dateKey}`);
                }
            });
            
            console.log('Days to clear:', daysToClear);
            console.log('Keys to remove:', keysToRemove);
            
            if (daysToClear === 0) {
                alert(`No data found for ${monthNames[targetMonth]} ${targetYear}.\n\nDebug info: Found ${Object.keys(shiftData).length} total dates, but none match August 2024.`);
                return false;
            }
            
            if (confirm(`‚ö†Ô∏è Are you sure you want to clear all data for ${monthNames[targetMonth]} ${targetYear}?\n\nThis will remove data for ${daysToClear} day(s) and cannot be undone.`)) {
                // Remove the specified month's data
                keysToRemove.forEach(key => {
                    delete shiftData[key];
                });
                
                // Save updated data to localStorage
                localStorage.setItem('shiftManagerData', JSON.stringify(shiftData));
                
                // Refresh the calendar and performance tables
                generateCalendar();
                if (document.getElementById('performanceTable')) {
                    document.getElementById('performanceTable').innerHTML = '';
                }
                if (document.getElementById('weekendPriorityTable')) {
                    document.getElementById('weekendPriorityTable').innerHTML = '';
                }
                if (document.getElementById('leaderboardTable')) {
                    document.getElementById('leaderboardTable').innerHTML = '';
                }
                
                // Trigger auto-updates
                setTimeout(() => {
                    triggerAllAutoUpdates();
                }, 100);
                
                alert(`Successfully cleared ${daysToClear} day(s) of data for ${monthNames[targetMonth]} ${targetYear}.`);
                return true;
            }
            return false;
        }

        function showMonthClearSelector() {
            console.log('=== SHOW MONTH CLEAR SELECTOR ===');
            console.log('isAdmin:', isAdmin);
            console.log('currentUser:', currentUser);
            
            // Check if user has permission to clear data
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can clear data.');
                return;
            }
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Create month selector HTML
            const selectorHTML = `
                <div style="background: white; border: 1px solid #ccc; border-radius: 8px; padding: 20px; max-width: 400px; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin-top: 0; color: #e74c3c;">üóëÔ∏è Clear Month Data</h3>
                    <p style="color: #666; margin-bottom: 20px;">Select the month and year to clear:</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Month:</label>
                        <select id="clearMonthSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            ${monthNames.map((name, index) => 
                                `<option value="${index}" ${index === 7 ? 'selected' : ''}>${name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Year:</label>
                        <input type="number" id="clearYearInput" value="2024" min="2020" max="2030" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeMonthClearSelector()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="executeMonthClear()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Clear Data</button>
                    </div>
                </div>
            `;
            
            // Create overlay and show selector
            const overlay = document.createElement('div');
            overlay.id = 'monthClearOverlay';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            overlay.innerHTML = selectorHTML;
            document.body.appendChild(overlay);
            
            console.log('Overlay created and added to DOM');
            console.log('Overlay element:', overlay);
            console.log('Overlay HTML:', selectorHTML);
        }

        function closeMonthClearSelector() {
            const overlay = document.getElementById('monthClearOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function executeMonthClear() {
            const monthSelect = document.getElementById('clearMonthSelect');
            const yearInput = document.getElementById('clearYearInput');
            
            if (monthSelect && yearInput) {
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearInput.value);
                
                if (isNaN(year) || year < 2020 || year > 2030) {
                    alert('Please enter a valid year between 2020 and 2030.');
                    return;
                }
                
                closeMonthClearSelector();
                clearMonthData(month, year);
            }
        }

        function debugCurrentData() {
            console.log('=== DEBUG CURRENT DATA ===');
            console.log('Current date:', currentDate);
            console.log('Current month:', currentDate.getMonth(), 'Current year:', currentDate.getFullYear());
            console.log('All shiftData keys:', Object.keys(shiftData));
            console.log('shiftData object:', shiftData);
            
            // Check for August 2024 data specifically
            const august2024Data = {};
            Object.keys(shiftData).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date.getMonth() === 7 && date.getFullYear() === 2024) {
                    august2024Data[dateKey] = shiftData[dateKey];
                }
            });
            
            console.log('August 2024 data found:', august2024Data);
            console.log('August 2024 data keys:', Object.keys(august2024Data));
            
            // Show alert with summary
            const totalDates = Object.keys(shiftData).length;
            const augustDates = Object.keys(august2024Data).length;
            
            alert(`üîç Data Debug Summary:\n\n` +
                  `Total dates in system: ${totalDates}\n` +
                  `August 2024 dates: ${augustDates}\n` +
                  `Current month: ${currentDate.getMonth()}\n` +
                  `Current year: ${currentDate.getFullYear()}\n\n` +
                  `Check browser console for detailed information.`);
        }

        // Developer-only helper removed as unused in production: debugData()

        // Payment calculation functions
        function calculateBasicPay(stars, date = null) {
            // Check if it's a weekend (Saturday = 6, Sunday = 0)
            if (date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                    return stars * (parseFloat(weekendRate) || 14.60); // Use configured weekend rate
                }
            }
            
            // Find the applicable rate for the total number of stars (weekdays only)
            let applicableRate = starRates[0].rate; // Default to first tier
            
            for (let i = starRates.length - 1; i >= 0; i--) {
                if (stars >= starRates[i].min) {
                    applicableRate = starRates[i].rate;
                    break;
                }
            }
            
            // Calculate pay using the applicable rate for all stars
            return stars * applicableRate;
        }

        function calculateBonusPay(stars, shifts, employeeName, bonusAdjustments = null) {
            let bonus = 0;
            
            // Apply bonus adjustments if provided (for management issues or partner leaves/no-shows)
            let adjustedStars = stars;
            let adjustedShifts = shifts;
            
            if (bonusAdjustments) {
                adjustedStars += bonusAdjustments.stars || 0;
                adjustedShifts += bonusAdjustments.attendance || 0;
            }
            
            // Target Achievement Bonus (800+ stars, including adjustments)
            if (adjustedStars >= 800) {
                bonus += 1000;
            }
            
            // Attendance Bonus (20+ working days, including adjustments)
            if (adjustedShifts >= 20) {
                bonus += 1000;
            }
            
            // Fuel Bonus (20+ working days, including adjustments)
            if (adjustedShifts >= 20) {
                bonus += 1000;
            }
            
            return bonus;
        }

        function calculatePerformance() {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            console.log('=== CALCULATING PERFORMANCE ===');
            console.log('Current month/year:', currentMonth, currentYear);
            console.log('Current date object:', currentDate);
            console.log('All shiftData keys:', Object.keys(shiftData));
            
            let employeeStats = {};
            let processedDates = [];
            let skippedDates = [];
            
            // Calculate monthly statistics with per-day pay calculation
            Object.keys(shiftData).forEach(dateKey => {
                const date = new Date(dateKey);
                console.log(`Checking date: ${dateKey}`);
                console.log(`  - Date object:`, date);
                console.log(`  - Date month: ${date.getMonth()}, year: ${date.getFullYear()}`);
                console.log(`  - Current month: ${currentMonth}, year: ${currentYear}`);
                console.log(`  - Month match: ${date.getMonth() === currentMonth}`);
                console.log(`  - Year match: ${date.getFullYear() === currentYear}`);
                
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    console.log(`‚úÖ INCLUDING date: ${dateKey}`);
                    processedDates.push(dateKey);
                    
                    Object.values(shiftData[dateKey]).forEach(shift => {
                        if (shift.employees && shift.employees.length > 0) {
                            // Count stars and calculate pay for each employee per day
                            shift.employees.forEach(employee => {
                                if (!employeeStats[employee]) {
                                    employeeStats[employee] = { stars: 0, shifts: 0, dailyPay: 0, lateDeductions: 0, partnerComp: 0 };
                                }
                                // Late code and stars used (allow stars even if no show)
                                const rawStars = (shift.stars && shift.stars[employee]) ? shift.stars[employee] : 0;
                                const lateCode = (shift.late && shift.late[employee]) ? shift.late[employee] : 'none';
                                const isNoShow = lateCode === '1.5hour';
                                // Count stars if provided, even when no show
                                const stars = rawStars;
                                
                                // Attendance: only count if not a No Show or Leave AND if stars > 2
                                {
                                    const preLate = (shift.late && shift.late[employee]) ? shift.late[employee] : 'none';
                                    if (preLate !== '1.5hour' && preLate !== 'leave') {
                                        // Only count attendance if employee earned more than 2 stars
                                        if (stars > 2) {
                                            employeeStats[employee].shifts++;
                                        }
                                    }
                                }
                                
                                // Add stars and earnings for the day
                                employeeStats[employee].stars += stars;
                                const dailyPay = calculateBasicPay(stars, date);
                                employeeStats[employee].dailyPay += dailyPay;
                                
                                // Late penalties and partner comp stay applied
                                const penaltyMap = { none: 0, '30min': 150, '1hour': 200, '1.5hour': 450, 'leave': 0 };
                                const penalty = penaltyMap[lateCode] || 0;
                                employeeStats[employee].lateDeductions = (employeeStats[employee].lateDeductions || 0) + penalty;
                                if (isNoShow) {
                                    const rep = shift.replacements ? shift.replacements[employee] : null;
                                    const partner = (shift.employees || []).find(e => e && e !== employee);
                                    // Partner comp only if no full cover
                                    const payPartnerComp = partner && !(rep && rep.employee && rep.fullyCovered);
                                    if (payPartnerComp) {
                                        if (!employeeStats[partner]) employeeStats[partner] = { stars: 0, shifts: 0, dailyPay: 0, lateDeductions: 0, partnerComp: 0 };
                                        employeeStats[partner].partnerComp = (employeeStats[partner].partnerComp || 0) + 250;
                                    }
                                    // Add replacement earnings if provided
                                    if (rep && rep.employee) {
                                        const rName = rep.employee;
                                        const rStars = rep.stars || 0;
                                        if (!employeeStats[rName]) employeeStats[rName] = { stars: 0, shifts: 0, dailyPay: 0, lateDeductions: 0, partnerComp: 0 };
                                        // count attendance for replacement
                                        employeeStats[rName].shifts = (employeeStats[rName].shifts || 0) + 1;
                                        employeeStats[rName].stars += rStars;
                                        const rPay = calculateBasicPay(rStars, date);
                                        employeeStats[rName].dailyPay += rPay;
                                    }
                                }
                                
                                // Handle Leave logic (similar to No Show but without ‚Çπ250 partner compensation)
                                if (lateCode === 'leave') {
                                    const rep = shift.replacements ? shift.replacements[employee] : null;
                                    const partner = (shift.employees || []).find(e => e && e !== employee);
                                    
                                    if (partner) {
                                        if (!employeeStats[partner]) employeeStats[partner] = { stars: 0, shifts: 0, dailyPay: 0, lateDeductions: 0, partnerComp: 0 };
                                        
                                        // Check if partner got a replacement
                                        const hasReplacement = rep && rep.employee && rep.fullyCovered;
                                        
                                        if (!hasReplacement) {
                                            // Partner didn't get a replacement, so they get bonus eligibility adjustments
                                            // +40 stars, +1 attendance day, +1 fuel day for bonus eligibility
                                            if (!employeeStats[partner].bonusAdjustments) {
                                                employeeStats[partner].bonusAdjustments = { stars: 0, attendance: 0, fuel: 0 };
                                            }
                                            employeeStats[partner].bonusAdjustments.stars += 40;
                                            employeeStats[partner].bonusAdjustments.attendance += 1;
                                            employeeStats[partner].bonusAdjustments.fuel += 1;
                                            
                                            console.log(`Bonus eligibility adjusted for ${partner}: +40 stars, +1 attendance, +1 fuel (leave)`);
                                        }
                                    }
                                    
                                    // Add replacement earnings if provided
                                    if (rep && rep.employee) {
                                        const rName = rep.employee;
                                        const rStars = rep.stars || 0;
                                        if (!employeeStats[rName]) employeeStats[rName] = { stars: 0, shifts: 0, dailyPay: 0, lateDeductions: 0, partnerComp: 0 };
                                        // count attendance for replacement
                                        employeeStats[rName].shifts = (employeeStats[rName].shifts || 0) + 1;
                                        employeeStats[rName].stars += rStars;
                                        const rPay = calculateBasicPay(rStars, date);
                                        employeeStats[rName].dailyPay += rPay;
                                    }
                                }
                                
                                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                                const rateInfo = isWeekend ? ' (weekend rate)' : '';
                                console.log(`  - ${employee} on ${dateKey} (${dayName}): starsUsed=${stars}, pay=‚Çπ${dailyPay}${rateInfo}, penalty=‚Çπ${penalty}${isNoShow ? ' (No Show)' : ''}`);
                            });
                        }
                    });
                } else {
                    console.log(`‚ùå SKIPPING date: ${dateKey} (month/year mismatch)`);
                    skippedDates.push(dateKey);
                }
            });
            
            console.log('Processed dates:', processedDates);
            console.log('Skipped dates:', skippedDates);
            console.log('Final employee stats:', employeeStats);
            
            // Convert to array and sort by total earnings (descending)
            const employeeArray = Object.keys(employeeStats).map(employee => ({
                name: employee,
                ...employeeStats[employee]
            })).sort((a, b) => {
                const aBonusPay = calculateBonusPay(a.stars, a.shifts, a.name, a.bonusAdjustments);
                const aLate = a.lateDeductions || 0;
                const aComp = a.partnerComp || 0;
                const aTotalPay = (a.dailyPay || 0) + aBonusPay - aLate + aComp;
                
                const bBonusPay = calculateBonusPay(b.stars, b.shifts, b.name, b.bonusAdjustments);
                const bLate = b.lateDeductions || 0;
                const bComp = b.partnerComp || 0;
                const bTotalPay = (b.dailyPay || 0) + bBonusPay - bLate + bComp;
                
                return bTotalPay - aTotalPay;
            });
            
            // Display the performance table
            displayPerformanceTable(employeeArray);
        }

        function calculateWeekendPriority() {
            // Check if user has permission to calculate weekend priority
            if (!isAdmin) {
                // For viewers, try to display existing weekend priority data if available
                displayExistingWeekendPriorityData();
                return;
            }
            
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Get all employees and their data
            const employeeWeekendData = {};
            
            // Initialize employee data
            allEmployees.forEach(emp => {
                employeeWeekendData[emp] = {
                    name: emp,
                    missedShifts: 0,
                    totalStars: 0,
                    workingDays: 0,
                    priorityScore: 0,
                    missedShiftReasons: [],
                    assignedButNoWork: 0
                };
            });
            
            // Analyze shift data for the current month
            Object.keys(shiftData).forEach((dateKey) => {
                const date = new Date(dateKey);
                if (date.getMonth() !== currentMonth || date.getFullYear() !== currentYear) return;
                
                const dayData = shiftData[dateKey];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                Object.keys(dayData).forEach((shiftId) => {
                    const shift = dayData[shiftId];
                    
                    // Check for missed shifts due to management issues or partner absence
                    if (shift.managementIssue || shift.reason === 'No pass') {
                        const defaultEmployees = getDefaultEmployeesForShift(shiftId);
                        defaultEmployees.forEach(emp => {
                            if (employeeWeekendData[emp]) {
                                employeeWeekendData[emp].missedShifts++;
                                employeeWeekendData[emp].missedShiftReasons.push({
                                    date: dateKey,
                                    shift: shiftId,
                                    reason: shift.reason || 'Management Issue'
                                });
                            }
                        });
                    }
                    
                    // Check for missed shifts due to partner "No Show" without replacement
                    if (shift.employees && shift.employees.length > 0) {
                        shift.employees.forEach(emp => {
                            const lateCode = shift.late && shift.late[emp] ? shift.late[emp] : 'none';
                            
                            if (lateCode === '1.5hour') {
                                // This employee is marked as "No Show"
                                const replacement = shift.replacements && shift.replacements[emp];
                                
                                // Find the partner who was supposed to work with them
                                const partner = shift.employees.find(e => e && e !== emp);
                                
                                if (partner && employeeWeekendData[partner]) {
                                    // Check if partner got a replacement
                                    if (!replacement || !replacement.employee || !replacement.fullyCovered) {
                                        // Partner didn't get a replacement, so they missed their shift
                                        employeeWeekendData[partner].missedShifts++;
                                        employeeWeekendData[partner].missedShiftReasons.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            reason: `Partner ${emp} marked as No Show without replacement`
                                        });
                                    }
                                }
                            } else if (lateCode === 'leave') {
                                // This employee is marked as "Leave"
                                const replacement = shift.replacements && shift.replacements[emp];
                                
                                // Find the partner who was supposed to work with them
                                const partner = shift.employees.find(e => e && e !== emp);
                                
                                if (partner && employeeWeekendData[partner]) {
                                    // Check if partner got a replacement
                                    if (!replacement || !replacement.employee || !replacement.fullyCovered) {
                                        // Partner didn't get a replacement, so they missed their shift
                                        employeeWeekendData[partner].missedShifts++;
                                        employeeWeekendData[partner].missedShiftReasons.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            reason: `Partner ${emp} marked as Leave without replacement`
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // Count working days and stars for performance calculation
                    if (shift.employees && shift.employees.length > 0) {
                        shift.employees.forEach((emp) => {
                            if (employeeWeekendData[emp]) {
                                const lateCode = shift.late && shift.late[emp] ? shift.late[emp] : 'none';
                                
                                // Only count as working day if not marked as "No Show" or "Leave" AND if stars > 2
                                if (lateCode !== '1.5hour' && lateCode !== 'leave') {
                                    // Only count working day if employee earned more than 2 stars
                                    if (shift.stars && shift.stars[emp] && shift.stars[emp] > 2) {
                                        employeeWeekendData[emp].workingDays++;
                                    } else if (shift.stars && shift.stars[emp] !== undefined && shift.stars[emp] <= 2) {
                                        // Employee was assigned but earned ‚â§ 2 stars (absent/no work done)
                                        // This will reduce priority score by 20 points
                                        if (!employeeWeekendData[emp].assignedButNoWork) {
                                            employeeWeekendData[emp].assignedButNoWork = 0;
                                        }
                                        employeeWeekendData[emp].assignedButNoWork++;
                                    }
                                }
                                
                                if (shift.stars && shift.stars[emp]) {
                                    employeeWeekendData[emp].totalStars += shift.stars[emp];
                                }
                            }
                        });
                        
                        // Count replacement employees as working
                        if (shift.replacements) {
                            Object.values(shift.replacements).forEach(rep => {
                                if (rep && rep.employee && employeeWeekendData[rep.employee]) {
                                    employeeWeekendData[rep.employee].workingDays++;
                                    if (rep.stars) {
                                        employeeWeekendData[rep.employee].totalStars += rep.stars;
                                    }
                                }
                            });
                        }
                    }
                });
            });
            
            // Calculate priority scores
            Object.values(employeeWeekendData).forEach(emp => {
                // First priority: NO PASS/Management Issues (highest priority)
                // Use 100 as base since max stars per shift is 50, so this ensures NO PASS always wins
                const noPassScore = emp.missedShiftReasons.filter(r => 
                    r.reason === 'Management Issue' || r.reason === 'No pass'
                ).length * 100;
                
                // Second priority: Partner No Show without replacement (second highest priority)
                // Use 50 as base since this is the max stars per shift
                const partnerNoShowScore = emp.missedShiftReasons.filter(r => 
                    r.reason.includes('Partner') && r.reason.includes('No Show')
                ).length * 50;
                
                // Third priority: star performance (higher stars = higher priority)
                const starScore = emp.totalStars;
                
                // Fourth priority: penalty for assigned but no work done (-20 points per day)
                const assignedButNoWorkPenalty = (emp.assignedButNoWork || 0) * -20;
                
                // Combined priority score
                emp.priorityScore = noPassScore + partnerNoShowScore + starScore + assignedButNoWorkPenalty;
            });
            
            // Sort by priority score (highest first)
            const sortedEmployees = Object.values(employeeWeekendData)
                .filter(emp => emp.workingDays > 0 || emp.missedShifts > 0)
                .sort((a, b) => b.priorityScore - a.priorityScore);
            
            displayWeekendPriorityTable(sortedEmployees);
        }

        function getDefaultEmployeesForShift(shiftId) {
            // Use the global defaultEmployees variable that can be updated
            return defaultEmployees[shiftId] || [];
        }

        function displayWeekendPriorityTable(employeeArray) {
            const container = document.getElementById('weekendPriorityTable');
            
            if (!employeeArray || employeeArray.length === 0) {
                container.innerHTML = `
                    <div class="no-weekend-data">
                        <h4>No Data Available</h4>
                        <p>No employee data found for the current month.</p>
                    </div>
                `;
                return;
            }
            
            // Store the calculated data for viewers to access later
            if (isAdmin) {
                localStorage.setItem('weekendPriorityData', JSON.stringify({
                    data: employeeArray,
                    calculatedAt: new Date().toISOString(),
                    month: currentDate.getMonth(),
                    year: currentDate.getFullYear()
                }));
            }
            
            let tableHTML = `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #dee2e6;">
                    <strong>üìä Priority Score Explanation:</strong><br>
                    ‚Ä¢ <strong>NO PASS:</strong> +100 per missed shift (always highest priority)<br>
                    ‚Ä¢ <strong>Partner No Show:</strong> +50 per missed shift (second priority)<br>
                    ‚Ä¢ <strong>Stars:</strong> +1 per star earned (performance bonus)<br>
                    ‚Ä¢ <strong>Assigned but No Work:</strong> -20 per day (absent penalty)<br>
                    <em>Example: 2 NO PASS shifts + 40 stars - 1 absent day = 200 + 40 - 20 = 220 priority score</em>
                </div>
                <table class="weekend-priority-table">
                    <thead>
                        <tr>
                            <th>Priority Rank</th>
                            <th>Employee Name</th>
                            <th>Missed Shifts</th>
                            <th>Total Stars</th>
                            <th>Working Days</th>
                            <th>Assigned but No Work</th>
                            <th>Priority Score</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            employeeArray.forEach((employee, index) => {
                const priorityClass = index < 3 ? `priority-${index + 1}` : '';
                const missedShiftBadge = employee.missedShifts > 0 ? 
                    `<span class="missed-shift-badge">${employee.missedShifts} missed</span>` : '';
                const highPerformerBadge = employee.totalStars >= 800 ? 
                    '<span class="high-performer-badge">Top Performer</span>' : '';
                
                let status = '';
                if (employee.missedShiftReasons.some(r => r.reason === 'Management Issue' || r.reason === 'No pass')) {
                    status = `<span class="no-pass-badge">ü•á First Priority - NO PASS</span>`;
                } else if (employee.missedShiftReasons.some(r => r.reason.includes('Partner') && r.reason.includes('No Show'))) {
                    status = `<span class="partner-no-show-badge">ü•à Second Priority - Partner No Show</span>`;
                } else if (employee.totalStars >= 800) {
                    status = `<span class="high-performer-badge">ü•â Third Priority - High Performer</span>`;
                } else if (employee.workingDays > 0 && employee.totalStars > 0) {
                    // Only show green status if there's actual work done
                    status = `<span class="standard-priority-badge">‚úÖ Standard Priority - Active Worker</span>`;
                } else if (employee.assignedButNoWork > 0) {
                    // Employee was assigned but didn't work (absent)
                    status = `<span class="absent-badge">‚è∏Ô∏è Absent - ${employee.assignedButNoWork} day(s) assigned but no work</span>`;
                } else {
                    // No work done and no assignments - show neutral status
                    status = `<span class="no-work-badge">‚è∏Ô∏è No Work Done</span>`;
                }
                
                // Create details tooltip for missed shifts
                let details = '';
                if (employee.missedShifts > 0 && employee.missedShiftReasons.length > 0) {
                    const reasons = employee.missedShiftReasons.map(r => 
                        `${r.date} ${r.shift}: ${r.reason}`
                    ).join('; ');
                    details = `<span title="${reasons}" style="cursor: help; color: #e74c3c;">üìã ${employee.missedShifts} reason(s)</span>`;
                } else {
                    details = '-';
                }
                
                tableHTML += `
                    <tr class="${priorityClass}">
                        <td><strong>#${index + 1}</strong></td>
                        <td><strong>${employee.name}</strong></td>
                        <td>${missedShiftBadge || '0'}</td>
                        <td>${employee.totalStars} ‚≠ê</td>
                        <td>${employee.workingDays}</td>
                        <td>${employee.assignedButNoWork || 0}</td>
                        <td><strong>${employee.priorityScore}</strong></td>
                        <td>${status}</td>
                        <td>${details}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function showWeekendRules() {
            const rulesDiv = document.querySelector('.weekend-priority-rules');
            if (rulesDiv.style.display === 'none') {
                rulesDiv.style.display = 'block';
            } else {
                rulesDiv.style.display = 'none';
            }
        }

        function displayExistingWeekendPriorityData() {
            const container = document.getElementById('weekendPriorityTable');
            const storedData = localStorage.getItem('weekendPriorityData');
            
            if (!storedData) {
                container.innerHTML = `
                    <div class="no-weekend-data">
                        <h4>No Weekend Priority Data Available</h4>
                        <p>Weekend shift priority data has not been calculated yet. Please ask a manager or administrator to calculate the data.</p>
                    </div>
                `;
                return;
            }
            
            try {
                const parsedData = JSON.parse(storedData);
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                
                // Check if the stored data is for the current month
                if (parsedData.month === currentMonth && parsedData.year === currentYear) {
                    // Display the stored data
                    displayWeekendPriorityTable(parsedData.data);
                    
                    // Add a note that this is stored data
                    const noteDiv = document.createElement('div');
                    noteDiv.style.cssText = 'background: #e3f2fd; padding: 8px 12px; border-radius: 4px; margin-bottom: 16px; border: 1px solid #bbdefb; text-align: center;';
                    noteDiv.innerHTML = `
                        <span style="color: #1976d2; font-size: 0.9rem;">
                            <strong>üìä Viewing stored data</strong> - Last calculated: ${new Date(parsedData.calculatedAt).toLocaleString()}
                        </span>
                    `;
                    container.insertBefore(noteDiv, container.firstChild);
                } else {
                    // Data is for a different month
                    container.innerHTML = `
                        <div class="no-weekend-data">
                            <h4>Data Outdated</h4>
                            <p>The stored weekend priority data is for a different month. Please ask a manager or administrator to recalculate the data for the current month.</p>
                            <p><strong>Stored data:</strong> ${new Date(parsedData.year, parsedData.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</p>
                            <p><strong>Current month:</strong> ${new Date(currentYear, currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error parsing stored weekend priority data:', error);
                container.innerHTML = `
                    <div class="no-weekend-data">
                        <h4>Data Error</h4>
                        <p>There was an error loading the stored weekend priority data. Please ask a manager or administrator to recalculate the data.</p>
                    </div>
                `;
            }
        }

        function clearOutdatedWeekendPriorityData() {
            const storedData = localStorage.getItem('weekendPriorityData');
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    const currentMonth = currentDate.getMonth();
                    const currentYear = currentDate.getFullYear();
                    
                    // If stored data is for a different month, clear it
                    if (parsedData.month !== currentMonth || parsedData.year !== currentYear) {
                        localStorage.removeItem('weekendPriorityData');
                        
                        // Clear the display for viewers
                        const container = document.getElementById('weekendPriorityTable');
                        if (container && !isAdmin) {
                            container.innerHTML = `
                                <div class="no-weekend-data">
                                    <h4>Data Outdated</h4>
                                    <p>The weekend priority data is for a different month. Please ask a manager or administrator to calculate new data for the current month.</p>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    // If there's an error parsing the data, clear it
                    localStorage.removeItem('weekendPriorityData');
                }
            }
        }

        function filterByEmployee(employeeName) {
            // Store original data if not already stored
            if (!filteredEmployee) {
                originalShiftData = JSON.parse(JSON.stringify(shiftData));
            }
            
            filteredEmployee = employeeName;
            
            // Filter shiftData to show only data for the selected employee
            const filteredData = {};
            
            Object.keys(originalShiftData).forEach(dateKey => {
                const dayData = originalShiftData[dateKey];
                const filteredDayData = {};
                
                Object.keys(dayData).forEach(shiftId => {
                    const shift = dayData[shiftId];
                    const filteredShift = {
                        employees: [],
                        reason: shift.reason,
                        stars: {},
                        managementIssue: shift.managementIssue
                    };
                    
                    // Only include this employee's data
                    if (shift.employees && shift.employees.includes(employeeName)) {
                        filteredShift.employees = [employeeName];
                        if (shift.stars && shift.stars[employeeName]) {
                            filteredShift.stars[employeeName] = shift.stars[employeeName];
                        }
                    }
                    
                    // Only add the shift if it has data for this employee
                    if (filteredShift.employees.length > 0 || filteredShift.reason) {
                        filteredDayData[shiftId] = filteredShift;
                    }
                });
                
                // Only add the day if it has any data
                if (Object.keys(filteredDayData).length > 0) {
                    filteredData[dateKey] = filteredDayData;
                }
            });
            
            // Update the current shiftData with filtered data
            shiftData = filteredData;
            
            // Regenerate calendar and performance table
            generateCalendar();
            calculatePerformance();
            
            console.log(`Filtered data for ${employeeName}:`, shiftData);
        }

        function clearEmployeeFilter() {
            if (filteredEmployee) {
                // Restore original data
                shiftData = JSON.parse(JSON.stringify(originalShiftData));
                filteredEmployee = null;
                originalShiftData = {};
                
                // Regenerate calendar and performance table
                generateCalendar();
                calculatePerformance();
                
                console.log('Employee filter cleared');
            }
        }

        function clearAllFilters() {
            // This function is called when filter state is lost but data appears filtered
            // We need to reload the original data from localStorage
            if (loadDataFromStorage()) {
                // Reset filter state
                filteredEmployee = null;
                originalShiftData = {};
                
                // Regenerate calendar and performance table
                generateCalendar();
                calculatePerformance();
                
                console.log('All filters cleared and data restored');
            } else {
                alert('Unable to restore original data. Please refresh the page.');
            }
        }

        // Developer-only helper removed as unused in production: testStarCalculations()

        function displayPerformanceTable(employeeArray) {
            const container = document.getElementById('performanceTable');
            
            if (employeeArray.length === 0) {
                container.innerHTML = `
                    <div class="no-data-message">
                        <h4>üìä No Performance Data Available</h4>
                        <p>Start assigning shifts and adding stars to see individual performance data!</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">
                            üí° <strong>Tip:</strong> Click on any day in the calendar, assign employees, and add stars to see the performance data populate here.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Check if data appears to be filtered (only one employee in the array)
            const isDataFiltered = employeeArray.length === 1 && filteredEmployee;
            const isDataAppearsFiltered = employeeArray.length === 1 && !filteredEmployee;
            
            // Create table structure with the exact columns requested
            const tableHTML = `
                <div class="performance-header">
                    ${isDataFiltered ? `
                        <div class="filter-info">
                            <span class="filter-badge">üë§ Filtered: ${filteredEmployee}</span>
                            <button onclick="clearEmployeeFilter()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px; font-size: 0.8rem;">
                                ‚úï Clear Filter
                            </button>
                        </div>
                        <div class="filter-summary" style="background: #e8f5e8; border: 1px solid #27ae60; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <strong>üìä Daily Earnings Summary for ${filteredEmployee}:</strong>
                            <div style="margin-top: 5px; font-size: 0.9rem;">
                                ${getDailyEarningsSummary(filteredEmployee)}
                            </div>
                        </div>
                    ` : ''}
                    ${isDataAppearsFiltered ? `
                        <div class="filter-info">
                            <span class="filter-badge">üë§ Data appears filtered (showing only ${employeeArray[0].name})</span>
                            <button onclick="clearAllFilters()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px; font-size: 0.8rem;">
                                ‚úï Clear All Filters
                            </button>
                        </div>
                    ` : ''}
                </div>
                    <table class="performance-table">
                        <thead>
                            <tr>
                                <th>Employee Name</th>
                                <th>Stars Completed</th>
                                <th>Attended</th>
                                <th>Total Earnings (INR) before bonus</th>
                                <th>Total Earnings (INR)</th>
                                <th>Daily Average</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${employeeArray.map((employee, index) => {
                                const bonusPay = calculateBonusPay(employee.stars, employee.shifts, employee.name, employee.bonusAdjustments);
                                const lateDeductions = employee.lateDeductions || 0;
                                const partnerComp = employee.partnerComp || 0;
                                const totalPay = (employee.dailyPay || 0) + bonusPay - lateDeductions + partnerComp;
                                const dailyAverage = employee.shifts > 0 ? (employee.stars / employee.shifts).toFixed(1) : '0.0';
                                
                                const notes = [];
                                if (lateDeductions > 0) notes.push(`<span style=\"color:#e74c3c\">Late: -‚Çπ${lateDeductions}</span>`);
                                if (partnerComp > 0) notes.push(`<span style=\"color:#27ae60\">Partner comp: +‚Çπ${partnerComp}</span>`);
                                const notesHtml = notes.length ? `<br><small>${notes.join(' | ')}</small>` : '';
                                
                                return `
                                    <tr class="${index < 3 ? `rank-${index + 1}` : ''}">
                                    <td>
                                        <strong class="employee-name-clickable" onclick="filterByEmployee('${employee.name}')" style="cursor: pointer; color: #3498db; text-decoration: underline;">
                                            ${employee.name}
                                        </strong>
                                    </td>
                                        <td>${employee.stars}</td>
                                        <td>${employee.shifts}</td>
                                    <td>‚Çπ${(employee.dailyPay || 0).toLocaleString()}</td>
                                    <td>‚Çπ${totalPay.toLocaleString()}${notesHtml}</td>
                                        <td>${dailyAverage}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function calculateLeaderboard() {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Get all employees and their leaderboard data
            const leaderboardData = {};
            
            // Initialize employee data
            allEmployees.forEach(emp => {
                leaderboardData[emp] = {
                    name: emp,
                    weekdayStars: 0,
                    weekendStars: 0,
                    compensatedWeekendStars: 0,
                    totalLeaderboardStars: 0,
                    workingDays: 0,
                    missedWeekdayShifts: 0,
                    compensationEligible: false,
                    multipleShiftDays: 0,
                    detailedBreakdown: []
                };
            });
            
            // Analyze shift data for the current month
            Object.keys(shiftData).forEach((dateKey) => {
                const date = new Date(dateKey);
                if (date.getMonth() !== currentMonth || date.getFullYear() !== currentYear) return;
                
                const dayData = shiftData[dateKey];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                // Track multiple shifts per day
                const shiftsWorked = {};
                
                Object.keys(dayData).forEach((shiftId) => {
                    const shift = dayData[shiftId];
                    
                    if (shift.employees && shift.employees.length > 0) {
                        shift.employees.forEach(emp => {
                            if (!leaderboardData[emp]) return;
                            
                            const lateCode = shift.late && shift.late[emp] ? shift.late[emp] : 'none';
                            
                            // Skip if marked as "No Show" or "Leave"
                            if (lateCode === '1.5hour' || lateCode === 'leave') return;
                            
                            // Count working days
                            if (!shiftsWorked[emp]) {
                                leaderboardData[emp].workingDays++;
                                shiftsWorked[emp] = 1;
                            } else {
                                shiftsWorked[emp]++;
                                leaderboardData[emp].multipleShiftDays++;
                            }
                            
                            // Count stars based on shift type and multiple shift rules
                            if (shift.stars && shift.stars[emp]) {
                                const stars = shift.stars[emp];
                                
                                if (isWeekend) {
                                    leaderboardData[emp].weekendStars += stars;
                                    
                                    // Check if this weekend shift compensates for a missed weekday
                                    if (leaderboardData[emp].compensationEligible) {
                                        const compensationNeeded = leaderboardData[emp].missedWeekdayShifts * 50; // Assume 50 stars per shift
                                        const alreadyCompensated = leaderboardData[emp].compensatedWeekendStars;
                                        
                                        if (alreadyCompensated < compensationNeeded) {
                                            const canCompensate = Math.min(stars, compensationNeeded - alreadyCompensated);
                                            leaderboardData[emp].compensatedWeekendStars += canCompensate;
                                            leaderboardData[emp].totalLeaderboardStars += canCompensate;
                                            
                                            leaderboardData[emp].detailedBreakdown.push({
                                                date: dateKey,
                                                shift: shiftId,
                                                type: 'Weekend Compensation',
                                                stars: canCompensate,
                                                note: `Compensating for missed weekday shift`
                                            });
                                        }
                                    }
                                } else {
                                    // Weekday shift
                                    if (shiftsWorked[emp] === 1) {
                                        // First shift of the day - count all stars
                                        leaderboardData[emp].weekdayStars += stars;
                                        leaderboardData[emp].totalLeaderboardStars += stars;
                                        
                                        leaderboardData[emp].detailedBreakdown.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            type: 'Weekday',
                                            stars: stars,
                                            note: 'First shift of the day'
                                        });
                                    } else {
                                        // Second shift of the day - max 10 stars count towards leaderboard
                                        const leaderboardStars = Math.min(stars, 10);
                                        leaderboardData[emp].weekdayStars += leaderboardStars;
                                        leaderboardData[emp].totalLeaderboardStars += leaderboardStars;
                                        
                                        leaderboardData[emp].detailedBreakdown.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            type: 'Weekday (Multiple)',
                                            stars: stars,
                                            leaderboardStars: leaderboardStars,
                                            note: `Second shift - only ${leaderboardStars} stars count towards leaderboard`
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // Check for missed shifts that make employees eligible for compensation
                    if (shift.managementIssue || shift.reason === 'No pass') {
                        const defaultEmployees = getDefaultEmployeesForShift(shiftId);
                        defaultEmployees.forEach(emp => {
                            if (leaderboardData[emp]) {
                                leaderboardData[emp].missedWeekdayShifts++;
                                leaderboardData[emp].compensationEligible = true;
                                
                                leaderboardData[emp].detailedBreakdown.push({
                                    date: dateKey,
                                    shift: shiftId,
                                    type: 'Missed Weekday',
                                    stars: 0,
                                    note: `Missed due to ${shift.reason || 'Management Issue'}`
                                });
                            }
                        });
                    }
                    
                    // Check for partner "No Show" without replacement
                    if (shift.employees && shift.employees.length > 0) {
                        shift.employees.forEach(emp => {
                            const lateCode = shift.late && shift.late[emp] ? shift.late[emp] : 'none';
                            
                            if (lateCode === '1.5hour') {
                                const replacement = shift.replacements && shift.replacements[emp];
                                const partner = shift.employees.find(e => e && e !== emp);
                                
                                if (partner && leaderboardData[partner]) {
                                    if (!replacement || !replacement.employee || !replacement.fullyCovered) {
                                        leaderboardData[partner].missedWeekdayShifts++;
                                        leaderboardData[partner].compensationEligible = true;
                                        
                                        leaderboardData[partner].detailedBreakdown.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            type: 'Missed Weekday',
                                            stars: 0,
                                            note: `Partner ${emp} marked as No Show without replacement`
                                        });
                                    }
                                }
                            }
                        });
                    }
                });
            });
            
            // Filter eligible employees (>600 stars) and sort by leaderboard stars
            const eligibleEmployees = Object.values(leaderboardData)
                .filter(emp => emp.totalLeaderboardStars > 600)
                .sort((a, b) => {
                    // First sort by total leaderboard stars
                    if (b.totalLeaderboardStars !== a.totalLeaderboardStars) {
                        return b.totalLeaderboardStars - a.totalLeaderboardStars;
                    }
                    // Tie-break: higher attendance wins
                    return b.workingDays - a.workingDays;
                });
            
            displayLeaderboardTable(eligibleEmployees);
        }

        function displayLeaderboardTable(employeeArray) {
            const container = document.getElementById('leaderboardTable');
            
            if (!employeeArray || employeeArray.length === 0) {
                container.innerHTML = `
                    <div class="no-weekend-data">
                        <h4>No Eligible Employees</h4>
                        <p>No employees have completed more than 600 stars for the current month.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #dee2e6;">
                    <strong>üìä Leaderboard Summary:</strong><br>
                    ‚Ä¢ <strong>${employeeArray.length}</strong> employees eligible (>600 stars)<br>
                    ‚Ä¢ <strong>1st Place:</strong> ${employeeArray[0] ? employeeArray[0].name : 'N/A'} (${employeeArray[0] ? employeeArray[0].totalLeaderboardStars : 0} stars)<br>
                    ‚Ä¢ <strong>Prize Pool:</strong> ‚Çπ10,000 total
                </div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Employee Name</th>
                            <th>Weekday Stars</th>
                            <th>Weekend Compensation</th>
                            <th>Total Leaderboard Stars</th>
                            <th>Working Days</th>
                            <th>Prize</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let currentRank = 1;
            let previousStars = null;
            let previousAttendance = null;
            let tiedEmployees = [];
            
            employeeArray.forEach((employee, index) => {
                // Handle ties
                if (previousStars === employee.totalLeaderboardStars && 
                    previousAttendance === employee.workingDays) {
                    tiedEmployees.push(employee);
                } else {
                    // Process previous tie group
                    if (tiedEmployees.length > 1) {
                        // Split prize among tied employees
                        const prizeAmount = getPrizeAmount(currentRank);
                        const splitAmount = Math.round(prizeAmount / tiedEmployees.length);
                        
                        // Update the table HTML to show split prizes
                        tiedEmployees.forEach((tiedEmp, tiedIndex) => {
                            const tiedRankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                            tableHTML += `
                                <tr class="${tiedRankClass}">
                                    <td><strong>#${currentRank}</strong></td>
                                    <td><strong>${tiedEmp.name}</strong></td>
                                    <td>${tiedEmp.weekdayStars} ‚≠ê</td>
                                    <td>${tiedEmp.compensatedWeekendStars} ‚≠ê</td>
                                    <td><strong>${tiedEmp.totalLeaderboardStars} ‚≠ê</strong></td>
                                    <td>${tiedEmp.workingDays}</td>
                                    <td>‚Çπ${splitAmount.toLocaleString()} (split)</td>
                                    <td>
                                        <span title="${getDetailedBreakdown(tiedEmp)}" style="cursor: help; color: #007bff;">
                                            üìã ${tiedEmp.detailedBreakdown.length} entries
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        currentRank += tiedEmployees.length;
                        tiedEmployees = [];
                    } else if (tiedEmployees.length === 1) {
                        // Single employee from previous tie
                        const rankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                        const prizeAmount = getPrizeAmount(currentRank);
                        
                        tableHTML += `
                            <tr class="${rankClass}">
                                <td><strong>#${currentRank}</strong></td>
                                <td><strong>${tiedEmployees[0].name}</strong></td>
                                <td>${tiedEmployees[0].weekdayStars} ‚≠ê</td>
                                <td>${tiedEmployees[0].compensatedWeekendStars} ‚≠ê</td>
                                <td><strong>${tiedEmployees[0].totalLeaderboardStars} ‚≠ê</strong></td>
                                <td>${tiedEmployees[0].workingDays}</td>
                                <td>‚Çπ${prizeAmount.toLocaleString()}</td>
                                <td>
                                    <span title="${getDetailedBreakdown(tiedEmployees[0])}" style="cursor: help; color: #007bff;">
                                        üìã ${tiedEmployees[0].detailedBreakdown.length} entries
                                    </span>
                                </td>
                            </tr>
                        `;
                        currentRank++;
                        tiedEmployees = [];
                    }
                    
                    // Start new potential tie group
                    tiedEmployees = [employee];
                }
                
                previousStars = employee.totalLeaderboardStars;
                previousAttendance = employee.workingDays;
            });
            
            // Handle last tie group
            if (tiedEmployees.length > 1) {
                const prizeAmount = getPrizeAmount(currentRank);
                const splitAmount = Math.round(prizeAmount / tiedEmployees.length);
                
                tiedEmployees.forEach(tiedEmp => {
                    const rankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                    tableHTML += `
                        <tr class="${rankClass}">
                            <td><strong>#${currentRank}</strong></td>
                            <td><strong>${tiedEmp.name}</strong></td>
                            <td>${tiedEmp.weekdayStars} ‚≠ê</td>
                            <td>${tiedEmp.compensatedWeekendStars} ‚≠ê</td>
                            <td><strong>${tiedEmp.totalLeaderboardStars} ‚≠ê</strong></td>
                            <td>${tiedEmp.workingDays}</td>
                            <td>‚Çπ${splitAmount.toLocaleString()} (split)</td>
                            <td>
                                <span title="${getDetailedBreakdown(tiedEmp)}" style="cursor: help; color: #007bff;">
                                    üìã ${tiedEmp.detailedBreakdown.length} entries
                                </td>
                            </tr>
                    `;
                });
            } else if (tiedEmployees.length === 1) {
                // Single employee from last tie
                const rankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                const prizeAmount = getPrizeAmount(currentRank);
                
                tableHTML += `
                    <tr class="${rankClass}">
                        <td><strong>#${currentRank}</strong></td>
                        <td><strong>${tiedEmployees[0].name}</strong></td>
                        <td>${tiedEmployees[0].weekdayStars} ‚≠ê</td>
                        <td>${tiedEmployees[0].compensatedWeekendStars} ‚≠ê</td>
                        <td><strong>${tiedEmployees[0].totalLeaderboardStars} ‚≠ê</strong></td>
                        <td>${tiedEmployees[0].workingDays}</td>
                        <td>‚Çπ${prizeAmount.toLocaleString()}</td>
                        <td>
                            <span title="${getDetailedBreakdown(tiedEmployees[0])}" style="cursor: help; color: #007bff;">
                                üìã ${tiedEmployees[0].detailedBreakdown.length} entries
                            </span>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getPrizeAmount(rank) {
            const prizes = { 1: 5000, 2: 3000, 3: 2000 };
            return prizes[rank] || 0;
        }

        function getDetailedBreakdown(employee) {
            return employee.detailedBreakdown.map(entry => 
                `${entry.date} ${entry.shift}: ${entry.type} - ${entry.stars} stars${entry.note ? ` (${entry.note})` : ''}`
            ).join('\n');
        }

        function showLeaderboardRules() {
            const rulesDiv = document.querySelector('.leaderboard-rules');
            if (rulesDiv.style.display === 'none') {
                rulesDiv.style.display = 'block';
            } else {
                rulesDiv.style.display = 'none';
            }
        }

        function showLeaderboardPrizes() {
            const prizesDiv = document.querySelector('.leaderboard-prizes');
            if (prizesDiv.style.display === 'none') {
                prizesDiv.style.display = 'block';
            } else {
                prizesDiv.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('shiftModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function calculateWeeklyLeaderboard() {
            // Check if user has permission to calculate leaderboard
            if (!isAdmin) {
                alert('üîí Access Denied: Only administrators can calculate weekly leaderboards.');
                return;
            }
            
            // Get current week (Monday to Sunday)
            const today = new Date();
            const currentWeekStart = getWeekStart(today);
            const currentWeekEnd = getWeekEnd(today);
            
            calculateLeaderboardForWeek(currentWeekStart, currentWeekEnd);
        }

        function selectWeek() {
            const weekSelector = document.querySelector('.week-selector');
            if (weekSelector.style.display === 'none') {
                weekSelector.style.display = 'block';
                // Set current week as default
                const today = new Date();
                const weekStart = getWeekStart(today);
                const weekInput = document.getElementById('weekInput');
                weekInput.value = formatWeekInput(weekStart);
                
                // Store current week for navigation
                window.currentSelectedWeek = weekStart;
            } else {
                weekSelector.style.display = 'none';
            }
        }

        function calculateSelectedWeek() {
            const weekInput = document.getElementById('weekInput');
            const selectedWeek = weekInput.value;
            
            if (!selectedWeek) {
                alert('Please select a week first');
                return;
            }
            
            // Parse the week input (format: YYYY-WNN)
            const [year, weekNum] = selectedWeek.split('-W');
            const weekStart = getWeekStartFromWeekNumber(parseInt(year), parseInt(weekNum));
            const weekEnd = getWeekEnd(weekStart);
            
            calculateLeaderboardForWeek(weekStart, weekEnd);
        }

        function getWeekStart(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            return new Date(date.setDate(diff));
        }

        function getWeekEnd(weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return weekEnd;
        }

        function formatWeekInput(date) {
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${weekNum.toString().padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function getWeekStartFromWeekNumber(year, weekNum) {
            const firstDayOfYear = new Date(year, 0, 1);
            const firstWeekday = firstDayOfYear.getDay();
            const daysToAdd = (weekNum - 1) * 7 - firstWeekday + 1;
            const weekStart = new Date(year, 0, 1 + daysToAdd);
            return getWeekStart(weekStart);
        }

        function calculateLeaderboardForWeek(weekStart, weekEnd) {
            // Get all employees and their leaderboard data for the specific week
            const leaderboardData = {};
            
            // Initialize employee data
            allEmployees.forEach(emp => {
                leaderboardData[emp] = {
                    name: emp,
                    weekdayStars: 0,
                    weekendStars: 0,
                    compensatedWeekendStars: 0,
                    totalLeaderboardStars: 0,
                    workingDays: 0,
                    missedWeekdayShifts: 0,
                    compensationEligible: false,
                    multipleShiftDays: 0,
                    detailedBreakdown: []
                };
            });
            
            // Analyze shift data for the specific week
            Object.keys(shiftData).forEach((dateKey) => {
                const date = new Date(dateKey);
                
                // Check if date falls within the selected week
                if (date < weekStart || date > weekEnd) return;
                
                const dayData = shiftData[dateKey];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                // Track multiple shifts per day
                const shiftsWorked = {};
                
                Object.keys(dayData).forEach((shiftId) => {
                    const shift = dayData[shiftId];
                    
                    if (shift.employees && shift.employees.length > 0) {
                        shift.employees.forEach(emp => {
                            if (!leaderboardData[emp]) return;
                            
                            const lateCode = shift.late && shift.late[emp] ? shift.late[emp] : 'none';
                            
                            // Skip if marked as "No Show" or "Leave"
                            if (lateCode === '1.5hour' || lateCode === 'leave') return;
                            
                            // Count working days
                            if (!shiftsWorked[emp]) {
                                leaderboardData[emp].workingDays++;
                                shiftsWorked[emp] = 1;
                            } else {
                                shiftsWorked[emp]++;
                                leaderboardData[emp].multipleShiftDays++;
                            }
                            
                            // Count stars based on shift type and multiple shift rules
                            if (shift.stars && shift.stars[emp]) {
                                const stars = shift.stars[emp];
                                
                                if (isWeekend) {
                                    leaderboardData[emp].weekendStars += stars;
                                    
                                    // Check if this weekend shift compensates for a missed weekday
                                    if (leaderboardData[emp].compensationEligible) {
                                        const compensationNeeded = leaderboardData[emp].missedWeekdayShifts * 50; // Assume 50 stars per shift
                                        const alreadyCompensated = leaderboardData[emp].compensatedWeekendStars;
                                        
                                        if (alreadyCompensated < compensationNeeded) {
                                            const canCompensate = Math.min(stars, compensationNeeded - alreadyCompensated);
                                            leaderboardData[emp].compensatedWeekendStars += canCompensate;
                                            leaderboardData[emp].totalLeaderboardStars += canCompensate;
                                            
                                            leaderboardData[emp].detailedBreakdown.push({
                                                date: dateKey,
                                                shift: shiftId,
                                                type: 'Weekend Compensation',
                                                stars: canCompensate,
                                                note: `Compensating for missed weekday shift`
                                            });
                                        }
                                    }
                                } else {
                                    // Weekday shift
                                    if (shiftsWorked[emp] === 1) {
                                        // First shift of the day - count all stars
                                        leaderboardData[emp].weekdayStars += stars;
                                        leaderboardData[emp].totalLeaderboardStars += stars;
                                        
                                        leaderboardData[emp].detailedBreakdown.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            type: 'Weekday',
                                            stars: stars,
                                            note: 'First shift of the day'
                                        });
                                    } else {
                                        // Second shift of the day - max 10 stars count towards leaderboard
                                        const leaderboardStars = Math.min(stars, 10);
                                        leaderboardData[emp].weekdayStars += leaderboardStars;
                                        leaderboardData[emp].totalLeaderboardStars += leaderboardStars;
                                        
                                        leaderboardData[emp].detailedBreakdown.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            type: 'Weekday (Multiple)',
                                            stars: stars,
                                            leaderboardStars: leaderboardStars,
                                            note: `Second shift - only ${leaderboardStars} stars count towards leaderboard`
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // Check for missed shifts that make employees eligible for compensation
                    if (shift.managementIssue || shift.reason === 'No pass') {
                        const defaultEmployees = getDefaultEmployeesForShift(shiftId);
                        defaultEmployees.forEach(emp => {
                            if (leaderboardData[emp]) {
                                leaderboardData[emp].missedWeekdayShifts++;
                                leaderboardData[emp].compensationEligible = true;
                                
                                leaderboardData[emp].detailedBreakdown.push({
                                    date: dateKey,
                                    shift: shiftId,
                                    type: 'Missed Weekday',
                                    stars: 0,
                                    note: `Missed due to ${shift.reason || 'Management Issue'}`
                                });
                            }
                        });
                    }
                    
                    // Check for partner "No Show" without replacement
                    if (shift.employees && shift.employees.length > 0) {
                        shift.employees.forEach(emp => {
                            const lateCode = shift.late && shift.late[emp] ? shift.late[emp] : 'none';
                            
                            if (lateCode === '1.5hour') {
                                const replacement = shift.replacements && shift.replacements[emp];
                                const partner = shift.employees.find(e => e && e !== emp);
                                
                                if (partner && leaderboardData[partner]) {
                                    if (!replacement || !replacement.employee || !replacement.fullyCovered) {
                                        leaderboardData[partner].missedWeekdayShifts++;
                                        leaderboardData[partner].compensationEligible = true;
                                        
                                        leaderboardData[partner].detailedBreakdown.push({
                                            date: dateKey,
                                            shift: shiftId,
                                            type: 'Missed Weekday',
                                            stars: 0,
                                            note: `Partner ${emp} marked as No Show without replacement`
                                        });
                                    }
                                }
                            }
                        });
                    }
                });
            });
            
            // Filter eligible employees (>150 stars for weekly) and sort by leaderboard stars
            const eligibleEmployees = Object.values(leaderboardData)
                .filter(emp => emp.totalLeaderboardStars > 150)
                .sort((a, b) => {
                    // First sort by total leaderboard stars
                    if (b.totalLeaderboardStars !== a.totalLeaderboardStars) {
                        return b.totalLeaderboardStars - a.totalLeaderboardStars;
                    }
                    // Tie-break: higher attendance wins
                    return b.workingDays - a.workingDays;
                });
            
            displayWeeklyLeaderboardTable(eligibleEmployees, weekStart, weekEnd);
        }

        function displayWeeklyLeaderboardTable(employeeArray, weekStart, weekEnd) {
            const container = document.getElementById('leaderboardTable');
            
            // Update week indicator
            const weekIndicator = document.getElementById('currentWeekIndicator');
            const weekDisplayText = document.getElementById('weekDisplayText');
            const weekRange = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            
            weekDisplayText.textContent = weekRange;
            weekIndicator.style.display = 'block';
            
            if (!employeeArray || employeeArray.length === 0) {
                container.innerHTML = `
                    <div class="no-weekend-data">
                        <h4>No Eligible Employees</h4>
                        <p>No employees have completed more than 150 stars for the week of ${weekRange}.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #dee2e6;">
                    <strong>üìä Weekly Leaderboard Summary (${weekRange}):</strong><br>
                    ‚Ä¢ <strong>${employeeArray.length}</strong> employees eligible (>150 stars)<br>
                    ‚Ä¢ <strong>1st Place:</strong> ${employeeArray[0] ? employeeArray[0].name : 'N/A'} (${employeeArray[0] ? employeeArray[0].totalLeaderboardStars : 0} stars)<br>
                    ‚Ä¢ <strong>Weekly Prize Pool:</strong> ‚Çπ2,500
                </div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Employee Name</th>
                            <th>Weekday Stars</th>
                            <th>Weekend Compensation</th>
                            <th>Total Leaderboard Stars</th>
                            <th>Working Days</th>
                            <th>Weekly Prize</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let currentRank = 1;
            let previousStars = null;
            let previousAttendance = null;
            let tiedEmployees = [];
            
            employeeArray.forEach((employee, index) => {
                // Handle ties
                if (previousStars === employee.totalLeaderboardStars && 
                    previousAttendance === employee.workingDays) {
                    tiedEmployees.push(employee);
                } else {
                    // Process previous tie group
                    if (tiedEmployees.length > 1) {
                        // Split prize among tied employees
                        const prizeAmount = getWeeklyPrizeAmount(currentRank);
                        const splitAmount = Math.round(prizeAmount / tiedEmployees.length);
                        
                        // Update the table HTML to show split prizes
                        tiedEmployees.forEach((tiedEmp, tiedIndex) => {
                            const tiedRankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                            tableHTML += `
                                <tr class="${tiedRankClass}">
                                    <td><strong>#${currentRank}</strong></td>
                                    <td><strong>${tiedEmp.name}</strong></td>
                                    <td>${tiedEmp.weekdayStars} ‚≠ê</td>
                                    <td>${tiedEmp.compensatedWeekendStars} ‚≠ê</td>
                                    <td><strong>${tiedEmp.totalLeaderboardStars} ‚≠ê</strong></td>
                                    <td>${tiedEmp.workingDays}</td>
                                    <td>‚Çπ${splitAmount.toLocaleString()} (split)</td>
                                    <td>
                                        <span title="${getDetailedBreakdown(tiedEmp)}" style="cursor: help; color: #007bff;">
                                            üìã ${tiedEmp.detailedBreakdown.length} entries
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        currentRank += tiedEmployees.length;
                        tiedEmployees = [];
                    } else if (tiedEmployees.length === 1) {
                        // Single employee from previous tie
                        const rankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                        const prizeAmount = getWeeklyPrizeAmount(currentRank);
                        
                        tableHTML += `
                            <tr class="${rankClass}">
                                <td><strong>#${currentRank}</strong></td>
                                <td><strong>${tiedEmployees[0].name}</strong></td>
                                <td>${tiedEmployees[0].weekdayStars} ‚≠ê</td>
                                <td>${tiedEmployees[0].compensatedWeekendStars} ‚≠ê</td>
                                <td><strong>${tiedEmployees[0].totalLeaderboardStars} ‚≠ê</strong></td>
                                <td>${tiedEmployees[0].workingDays}</td>
                                <td>‚Çπ${prizeAmount.toLocaleString()}</td>
                                <td>
                                    <span title="${getDetailedBreakdown(tiedEmployees[0])}" style="cursor: help; color: #007bff;">
                                        üìã ${tiedEmployees[0].detailedBreakdown.length} entries
                                    </span>
                                </td>
                            </tr>
                        `;
                        currentRank++;
                        tiedEmployees = [];
                    }
                    
                    // Start new potential tie group
                    tiedEmployees = [employee];
                }
                
                previousStars = employee.totalLeaderboardStars;
                previousAttendance = employee.workingDays;
            });
            
            // Handle last tie group
            if (tiedEmployees.length > 1) {
                const prizeAmount = getWeeklyPrizeAmount(currentRank);
                const splitAmount = Math.round(prizeAmount / tiedEmployees.length);
                
                tiedEmployees.forEach(tiedEmp => {
                    const rankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                    tableHTML += `
                        <tr class="${rankClass}">
                            <td><strong>#${currentRank}</strong></td>
                            <td><strong>${tiedEmp.name}</strong></td>
                            <td>${tiedEmp.weekdayStars} ‚≠ê</td>
                            <td>${tiedEmp.compensatedWeekendStars} ‚≠ê</td>
                            <td><strong>${tiedEmp.totalLeaderboardStars} ‚≠ê</strong></td>
                            <td>${tiedEmp.workingDays}</td>
                            <td>‚Çπ${splitAmount.toLocaleString()} (split)</td>
                            <td>
                                <span title="${getDetailedBreakdown(tiedEmp)}" style="cursor: help; color: #007bff;">
                                    üìã ${tiedEmp.detailedBreakdown.length} entries
                                </td>
                            </tr>
                    `;
                });
            } else if (tiedEmployees.length === 1) {
                // Single employee from last tie
                const rankClass = currentRank <= 3 ? `rank-${currentRank}` : '';
                const prizeAmount = getWeeklyPrizeAmount(currentRank);
                
                tableHTML += `
                    <tr class="${rankClass}">
                        <td><strong>#${currentRank}</strong></td>
                        <td><strong>${tiedEmployees[0].name}</strong></td>
                        <td>${tiedEmployees[0].weekdayStars} ‚≠ê</td>
                        <td>${tiedEmployees[0].compensatedWeekendStars} ‚≠ê</td>
                        <td><strong>${tiedEmployees[0].totalLeaderboardStars} ‚≠ê</strong></td>
                        <td>${tiedEmployees[0].workingDays}</td>
                        <td>‚Çπ${prizeAmount.toLocaleString()}</td>
                        <td>
                            <span title="${getDetailedBreakdown(tiedEmployees[0])}" style="cursor: help; color: #007bff;">
                                üìã ${tiedEmployees[0].detailedBreakdown.length} entries
                            </span>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getWeeklyPrizeAmount(rank) {
            const prizes = { 1: 1250, 2: 750, 3: 500 };
            return prizes[rank] || 0;
        }

        function goToPreviousWeek() {
            if (!window.currentSelectedWeek) {
                window.currentSelectedWeek = getWeekStart(new Date());
            }
            
            const previousWeek = new Date(window.currentSelectedWeek);
            previousWeek.setDate(previousWeek.getDate() - 7);
            window.currentSelectedWeek = previousWeek;
            
            const weekInput = document.getElementById('weekInput');
            weekInput.value = formatWeekInput(previousWeek);
            
            // Calculate leaderboard for the previous week
            const weekEnd = getWeekEnd(previousWeek);
            calculateLeaderboardForWeek(previousWeek, weekEnd);
        }

        function goToNextWeek() {
            if (!window.currentSelectedWeek) {
                window.currentSelectedWeek = getWeekStart(new Date());
            }
            
            const nextWeek = new Date(window.currentSelectedWeek);
            nextWeek.setDate(nextWeek.getDate() + 7);
            window.currentSelectedWeek = nextWeek;
            
            const weekInput = document.getElementById('weekInput');
            weekInput.value = formatWeekInput(nextWeek);
            
            // Calculate leaderboard for the next week
            const weekEnd = getWeekEnd(nextWeek);
            calculateLeaderboardForWeek(nextWeek, weekEnd);
        }

        function goToCurrentWeek() {
            const today = new Date();
            const currentWeekStart = getWeekStart(today);
            window.currentSelectedWeek = currentWeekStart;
            
            const weekInput = document.getElementById('weekInput');
            weekInput.value = formatWeekInput(currentWeekStart);
            
            // Calculate leaderboard for the current week
            const weekEnd = getWeekEnd(currentWeekStart);
            calculateLeaderboardForWeek(currentWeekStart, weekEnd);
        }

        function goToQuickWeek() {
            const quickSelect = document.getElementById('quickWeekSelect');
            const selectedValue = quickSelect.value;
            
            if (!selectedValue) return;
            
            const today = new Date();
            let targetWeek;
            
            switch (selectedValue) {
                case 'current':
                    targetWeek = getWeekStart(today);
                    break;
                case 'last1':
                    targetWeek = new Date(today);
                    targetWeek.setDate(today.getDate() - 7);
                    targetWeek = getWeekStart(targetWeek);
                    break;
                case 'last2':
                    targetWeek = new Date(today);
                    targetWeek.setDate(today.getDate() - 14);
                    targetWeek = getWeekStart(targetWeek);
                    break;
                case 'last3':
                    targetWeek = new Date(today);
                    targetWeek.setDate(today.getDate() - 21);
                    targetWeek = getWeekStart(targetWeek);
                    break;
                case 'last4':
                    targetWeek = new Date(today);
                    targetWeek.setDate(today.getDate() - 28);
                    targetWeek = getWeekStart(targetWeek);
                    break;
                case 'last8':
                    targetWeek = new Date(today);
                    targetWeek.setDate(today.getDate() - 56);
                    targetWeek = getWeekStart(targetWeek);
                    break;
                case 'last12':
                    targetWeek = new Date(today);
                    targetWeek.setDate(today.getDate() - 84);
                    targetWeek = getWeekStart(targetWeek);
                    break;
            }
            
            if (targetWeek) {
                window.currentSelectedWeek = targetWeek;
                const weekInput = document.getElementById('weekInput');
                weekInput.value = formatWeekInput(targetWeek);
                
                // Calculate leaderboard for the selected week
                const weekEnd = getWeekEnd(targetWeek);
                calculateLeaderboardForWeek(targetWeek, weekEnd);
                
                // Reset quick select
                quickSelect.value = '';
            }
        }

        // Data persistence functions
        function saveDataToStorage() {
            try {
                const dataToSave = {
                    shiftData: shiftData,
                    allEmployees: allEmployees,
                    currentDate: currentDate.toISOString(),
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('shiftManagerData', JSON.stringify(dataToSave));
                
                // Update status indicator
                updateDataStatusIndicator(new Date().toISOString());
                
                console.log('Data saved successfully at:', new Date().toLocaleString());
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function updateDataStatusIndicator(lastSavedTime) {
            const statusIndicator = document.getElementById('dataStatusIndicator');
            const lastSavedText = document.getElementById('lastSavedText');
            
            if (lastSavedTime) {
                const lastSaved = new Date(lastSavedTime);
                const now = new Date();
                const timeDiff = now - lastSaved;
                
                let timeAgo;
                if (timeDiff < 60000) { // Less than 1 minute
                    timeAgo = 'Just now';
                } else if (timeDiff < 3600000) { // Less than 1 hour
                    timeAgo = `${Math.floor(timeDiff / 60000)} minutes ago`;
                } else if (timeDiff < 86400000) { // Less than 1 day
                    timeAgo = `${Math.floor(timeDiff / 3600000)} hours ago`;
                } else {
                    timeAgo = `${Math.floor(timeDiff / 86400000)} days ago`;
                }
                
                lastSavedText.textContent = `üíæ Data last saved: ${timeAgo}`;
                statusIndicator.style.display = 'block';
            } else {
                statusIndicator.style.display = 'none';
            }
        }

        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('shiftManagerData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    if (parsedData.shiftData) {
                        shiftData = parsedData.shiftData;
                        // Convert date strings back to Date objects
                        Object.keys(shiftData).forEach(dateKey => {
                            if (shiftData[dateKey]) {
                                Object.keys(shiftData[dateKey]).forEach(shiftId => {
                                    const shift = shiftData[dateKey][shiftId];
                                    if (shift && shift.date) {
                                        shift.date = new Date(shift.date);
                                    }
                                });
                            }
                        });
                    }
                    
                    if (parsedData.allEmployees && Array.isArray(parsedData.allEmployees)) {
                        allEmployees = parsedData.allEmployees;
                    }
                    
                    if (parsedData.currentDate) {
                        currentDate = new Date(parsedData.currentDate);
                    }
                    
                    // Update status indicator
                    updateDataStatusIndicator(parsedData.lastSaved);
                    
                    console.log('Data loaded successfully from:', parsedData.lastSaved ? new Date(parsedData.lastSaved).toLocaleString() : 'unknown time');
                    
                    // Check if data appears to be filtered (only one employee has data)
                    const employeeCount = new Set();
                    Object.keys(shiftData).forEach(dateKey => {
                        const dayData = shiftData[dateKey];
                        Object.keys(dayData).forEach(shiftId => {
                            const shift = dayData[shiftId];
                            if (shift.employees) {
                                shift.employees.forEach(emp => employeeCount.add(emp));
                            }
                        });
                    });
                    
                    // If only one employee has data, it might be filtered
                    if (employeeCount.size === 1) {
                        const singleEmployee = Array.from(employeeCount)[0];
                        console.log(`Data appears to be filtered for ${singleEmployee}. Use "Clear All Filters" button if needed.`);
                    }
                    
                    // Trigger auto-updates after loading data
                    setTimeout(() => {
                        triggerAllAutoUpdates();
                    }, 500);
                    
                    return true;
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            return false;
        }

        function autoSaveData() {
            // Auto-save every 30 seconds
            setInterval(() => {
                if (Object.keys(shiftData).length > 0) {
                    saveDataToStorage();
                }
            }, 30000);
        }

        // Duplicate clearAllData removed; unified above with permission checks

        function exportData() {
            try {
                const dataToExport = {
                    shiftData: shiftData,
                    allEmployees: allEmployees,
                    currentDate: currentDate.toISOString(),
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `shift-manager-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('Data exported successfully!');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        function importData() {
            // Check if user has permission to import data
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can import data.');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            if (importedData.shiftData) {
                                shiftData = importedData.shiftData;
                                // Convert date strings back to Date objects
                                Object.keys(shiftData).forEach(dateKey => {
                                    if (shiftData[dateKey]) {
                                        Object.keys(shiftData[dateKey]).forEach(shiftId => {
                                            const shift = shiftData[dateKey][shiftId];
                                            if (shift && shift.date) {
                                                shift.date = new Date(shift.date);
                                            }
                                        });
                                    }
                                });
                            }
                            
                            if (importedData.allEmployees && Array.isArray(importedData.allEmployees)) {
                                allEmployees = importedData.allEmployees;
                            }
                            
                            if (importedData.currentDate) {
                                currentDate = new Date(importedData.currentDate);
                            }
                            
                            // Save to localStorage
                            saveDataToStorage();
                            
                            // Refresh the display
                            generateCalendar();
                            
                            // Trigger auto-updates for viewers and Bhargav
                            setTimeout(() => {
                                triggerAllAutoUpdates();
                            }, 100);
                            
                            alert('Data imported successfully!');
                        } catch (error) {
                            console.error('Error importing data:', error);
                            alert('Error importing data. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        // Function to update allEmployees array based on defaultEmployees
        function updateAllEmployeesArray() {
            const uniqueEmployees = new Set();
            
            // Add all employees from default assignments
            Object.values(defaultEmployees).forEach(shiftEmployees => {
                shiftEmployees.forEach(employee => {
                    if (employee && employee.trim() !== '') {
                        uniqueEmployees.add(employee.trim());
                    }
                });
            });
            
            // Convert Set back to array and update allEmployees
            allEmployees = Array.from(uniqueEmployees);
        }

        // Function to refresh shift modal dropdowns with updated allEmployees
        function refreshShiftModalDropdowns() {
            // Only refresh if the modal is currently open
            const modal = document.getElementById('shiftModal');
            if (modal && modal.style.display === 'block') {
                // Close and reopen the modal to refresh the dropdowns
                const currentDate = selectedDate;
                if (currentDate) {
                    modal.style.display = 'none';
                    setTimeout(() => {
                        openShiftModal(currentDate);
                    }, 100);
                }
            }
        }

        // Predefined Lists Management Functions
        function togglePredefinedLists() {
            const content = document.getElementById('predefinedListsContent');
            const toggle = document.getElementById('predefinedListsToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }

        function savePredefinedLists() {
            // Check if user has permission to save configuration
            if (!isAdmin) {
                alert('üîí Access Denied: Only managers and administrators can save configuration.');
                return;
            }
            
            // Check if user can specifically edit predefined lists
            if (!currentUser || !currentUser.canEditPredefinedLists) {
                alert('üîí Access Denied: Only Raghu can edit Predefined Lists Management.');
                return;
            }

            try {
                // Check if all required input elements exist
                const requiredElements = [
                    'default-morning-1', 'default-morning-2',
                    'default-afternoon-1', 'default-afternoon-2',
                    'default-evening-1', 'default-evening-2',
                    'default-night-1', 'default-night-2',
                    'star-rate-0-20', 'star-rate-22-30', 'star-rate-32-40', 'star-rate-42-plus',
                    'weekend-rate',
                    'bonus-800-stars', 'bonus-20-days', 'bonus-fuel',
                    'prize-1st', 'prize-2nd', 'prize-3rd'
                ];
                
                for (const elementId of requiredElements) {
                    const element = document.getElementById(elementId);
                    if (!element) {
                        console.error(`Element with ID '${elementId}' not found!`);
                        throw new Error(`Required element '${elementId}' not found in DOM`);
                    }
                }
                
                // Save default employee assignments
                defaultEmployees = {
                    morning: [
                        document.getElementById('default-morning-1').value,
                        document.getElementById('default-morning-2').value
                    ],
                    afternoon: [
                        document.getElementById('default-afternoon-1').value,
                        document.getElementById('default-afternoon-2').value
                    ],
                    evening: [
                        document.getElementById('default-evening-1').value,
                        document.getElementById('default-evening-2').value
                    ],
                    night: [
                        document.getElementById('default-night-1').value,
                        document.getElementById('default-night-2').value
                    ]
                };

                // Save star rates
                starRates = [
                    { min: 0, max: 20, rate: parseFloat(document.getElementById('star-rate-0-20').value) },
                    { min: 22, max: 30, rate: parseFloat(document.getElementById('star-rate-22-30').value) },
                    { min: 32, max: 40, rate: parseFloat(document.getElementById('star-rate-32-40').value) },
                    { min: 42, max: Infinity, rate: parseFloat(document.getElementById('star-rate-42-plus').value) }
                ];

                // Save weekend rate
                weekendRate = parseFloat(document.getElementById('weekend-rate').value);

                // Save bonus amounts
                bonuses = {
                    target800: parseFloat(document.getElementById('bonus-800-stars').value),
                    attendance20: parseFloat(document.getElementById('bonus-20-days').value),
                    fuel: parseFloat(document.getElementById('bonus-fuel').value)
                };

                // Save prize amounts
                prizes = {
                    first: parseFloat(document.getElementById('prize-1st').value),
                    second: parseFloat(document.getElementById('prize-2nd').value),
                    third: parseFloat(document.getElementById('prize-3rd').value)
                };

                // Save to localStorage
                const configData = {
                    defaultEmployees,
                    starRates,
                    weekendRate,
                    bonuses,
                    prizes,
                    savedAt: new Date().toISOString()
                };

                localStorage.setItem('shiftManagerConfig', JSON.stringify(configData));

                // Update global variables
                // Note: These variables are already declared globally, so we just need to update their values

                // Update the allEmployees array to include any new employee names
                updateAllEmployeesArray();

                // Refresh shift modal dropdowns if modal is open
                refreshShiftModalDropdowns();

                // Update total prize pool display
                updateTotalPrizePool();

                // Update the default assignments display in the header
                updateDefaultAssignmentsDisplay();

                // Refresh the calendar to show updated default assignments
                generateCalendar();

                alert('‚úÖ Configuration saved successfully! Calendar updated with new default assignments.');

            } catch (error) {
                console.error('Error saving configuration:', error);
                alert('‚ùå Error saving configuration. Please check your inputs.');
            }
        }





        function loadSavedConfiguration() {
            try {
                const savedConfig = localStorage.getItem('shiftManagerConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    // Update default employees from saved config
                    if (config.defaultEmployees) {
                        defaultEmployees = config.defaultEmployees;
                        
                        // Update HTML input fields to match saved configuration
                        if (defaultEmployees.morning && defaultEmployees.morning.length >= 2) {
                            document.getElementById('default-morning-1').value = defaultEmployees.morning[0] || 'Bhargav';
                            document.getElementById('default-morning-2').value = defaultEmployees.morning[1] || 'Pranav';
                        }
                        if (defaultEmployees.afternoon && defaultEmployees.afternoon.length >= 2) {
                            document.getElementById('default-afternoon-1').value = defaultEmployees.afternoon[0] || 'Guru';
                            document.getElementById('default-afternoon-2').value = defaultEmployees.afternoon[1] || 'Kalyan';
                        }
                        if (defaultEmployees.evening && defaultEmployees.evening.length >= 2) {
                            document.getElementById('default-evening-1').value = defaultEmployees.evening[0] || 'Nawaz';
                            document.getElementById('default-evening-2').value = defaultEmployees.evening[1] || 'Nithin';
                        }
                        if (defaultEmployees.night && defaultEmployees.night.length >= 2) {
                            document.getElementById('default-night-1').value = defaultEmployees.night[0] || 'Vishrut';
                            document.getElementById('default-night-2').value = defaultEmployees.night[1] || 'Vishnu';
                        }
                    }
                    
                    // Update star rates in HTML inputs
                    if (config.starRates && config.starRates.length >= 4) {
                        document.getElementById('star-rate-0-20').value = config.starRates[0]?.rate || '9';
                        document.getElementById('star-rate-22-30').value = config.starRates[1]?.rate || '11';
                        document.getElementById('star-rate-32-40').value = config.starRates[2]?.rate || '13.60';
                        document.getElementById('star-rate-42-plus').value = config.starRates[3]?.rate || '14.60';
                    }
                    
                    // Update weekend rate in HTML input
                    if (config.weekendRate) {
                        document.getElementById('weekend-rate').value = config.weekendRate;
                    }
                    
                    // Update bonus amounts in HTML inputs
                    if (config.bonuses) {
                        document.getElementById('bonus-800-stars').value = config.bonuses.target800 || '1000';
                        document.getElementById('bonus-20-days').value = config.bonuses.attendance20 || '1000';
                        document.getElementById('bonus-fuel').value = config.bonuses.fuel || '1000';
                    }
                    
                    // Update prize amounts in HTML inputs
                    if (config.prizes) {
                        document.getElementById('prize-1st').value = config.prizes.first || '1250';
                        document.getElementById('prize-2nd').value = config.prizes.second || '750';
                        document.getElementById('prize-3rd').value = config.prizes.third || '500';
                    }
                    
                    // Update other global variables if needed
                    if (config.starRates) {
                        starRates = config.starRates;
                    }
                    if (config.weekendRate) {
                        weekendRate = config.weekendRate;
                    }
                    if (config.bonuses) {
                        bonuses = config.bonuses;
                    }
                    if (config.prizes) {
                        prizes = config.prizes;
                    }
                }
                
                // Update the allEmployees array based on loaded default employees
                updateAllEmployeesArray();
                
                // Update the display to show current default assignments
                updateDefaultAssignmentsDisplay();
                
                // Update total prize pool display
                updateTotalPrizePool();
                
                // Trigger auto-updates after loading configuration
                setTimeout(() => {
                    triggerAllAutoUpdates();
                }, 100);
            } catch (error) {
                console.error('Error loading saved configuration:', error);
                // Keep default values if there's an error
            }
        }

        function updateTotalPrizePool() {
            const first = parseFloat(document.getElementById('prize-1st').value) || 0;
            const second = parseFloat(document.getElementById('prize-2nd').value) || 0;
            const third = parseFloat(document.getElementById('prize-3rd').value) || 0;
            const total = first + second + third;
            
            document.getElementById('total-prize-pool').textContent = `‚Çπ${total.toLocaleString()}`;
        }

        function updateDefaultAssignmentsDisplay() {
            const displayElement = document.getElementById('defaultAssignmentsDisplay');
            if (displayElement && defaultEmployees) {
                const morning = defaultEmployees.morning?.join(' & ') || 'Not set';
                const afternoon = defaultEmployees.afternoon?.join(' & ') || 'Not set';
                const evening = defaultEmployees.evening?.join(' & ') || 'Not set';
                const night = defaultEmployees.night?.join(' & ') || 'Not set';
                
                displayElement.textContent = `Morning: ${morning} | Afternoon: ${afternoon} | Evening: ${evening} | Night: ${night}`;
            }
        }

        // Initialize configuration when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for prize pool calculation
            const prizeInputs = ['prize-1st', 'prize-2nd', 'prize-3rd'];
            prizeInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateTotalPrizePool);
                }
            });
            
            // Update the default assignments display after a short delay to ensure DOM is ready
            setTimeout(updateDefaultAssignmentsDisplay, 100);
        });

        // Refresh functions for manual updates
        function refreshPerformanceData() {
            calculatePerformance();
        }

        function refreshWeekendPriorityData() {
            if (isAdmin) {
                calculateWeekendPriority();
            } else {
                displayExistingWeekendPriorityData();
            }
        }

        function refreshLeaderboardData() {
            calculateWeeklyLeaderboard();
        }

        // Auto-update functions that run when data changes
        function autoUpdatePerformanceData() {
            // Auto-update performance data when shift data changes
            if (document.getElementById('performanceTable')) {
                // Only update if there's actual data to show
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                let hasDataForCurrentMonth = false;
                
                Object.keys(shiftData).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                        hasDataForCurrentMonth = true;
                    }
                });
                
                if (hasDataForCurrentMonth) {
                    calculatePerformance();
                } else {
                    // Just clear the table content, don't recalculate
                    document.getElementById('performanceTable').innerHTML = `
                        <div class="no-data-message">
                            <h4>üìä No Performance Data Available</h4>
                            <p>Start assigning shifts and adding stars to see individual performance data!</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">
                                üí° <strong>Tip:</strong> Click on any day in the calendar, assign employees, and add stars to see the performance data populate here.
                            </p>
                        </div>
                    `;
                }
            }
        }

        function autoUpdateWeekendPriorityData() {
            // Auto-update weekend priority data when shift data changes
            if (document.getElementById('weekendPriorityTable')) {
                if (isAdmin) {
                    calculateWeekendPriority();
                } else {
                    displayExistingWeekendPriorityData();
                }
            }
        }

        function autoUpdateLeaderboardData() {
            // Auto-update leaderboard data when shift data changes
            if (document.getElementById('leaderboardTable')) {
                calculateWeeklyLeaderboard();
            }
        }

        // Function to trigger all auto-updates
        function triggerAllAutoUpdates() {
            autoUpdatePerformanceData();
            autoUpdateWeekendPriorityData();
            autoUpdateLeaderboardData();
        }

        // Listen for localStorage changes (cross-tab live sync)
        window.addEventListener('storage', function(e) {
            try {
                if (e.key === 'shiftManagerData') {
                                    // Reload data and refresh UI
                loadDataFromStorage();
                generateCalendar();
                setTimeout(() => triggerAllAutoUpdates(), 500);
                } else if (e.key === 'shiftManagerConfig') {
                    // Reload configuration and refresh UI
                    loadSavedConfiguration();
                    generateCalendar();
                    setTimeout(() => triggerAllAutoUpdates(), 500);
                }
            } catch (err) {
                console.error('Storage sync error:', err);
            }
        });

    </script>
</body>
</html>
